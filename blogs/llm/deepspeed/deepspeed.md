# å¤§æ¨¡å‹è®­ç»ƒå·¥å…·ä¹‹Deepspeed

# ä»€ä¹ˆæ˜¯deepspeed?
å¤§æ¨¡å‹ç«äº†ä¹‹åï¼Œå¤§æ¨¡å‹çš„åˆ†å¸ƒå¼è®­ç»ƒè‡ªç„¶è€Œç„¶æˆä¸ºäº†ä¸€ä¸ªç ”ç©¶çƒ­ç‚¹ï¼Œå…¶ä¸­ `deepspeed` æ— ç–‘æ˜¯ æœ€ç«çˆ†çš„å¼€æºåˆ†å¸ƒå¼è®­ç»ƒæ¡†æ¶ä¹‹ä¸€ã€‚

åœ¨å¼€å§‹è®²deepspeedå‰ï¼Œå…ˆæ•´ç†ä¸€ä¸‹å¤§æ¨¡å‹åˆ†å¸ƒå¼è®­ç»ƒçš„å…³é”®é€»è¾‘å’Œé—®é¢˜ï¼Œè¿™æ ·æ›´å®¹æ˜“ç†è§£ä¸€äº›æŠ€æœ¯ç‚¹åˆ°åº•æ˜¯ä¸ºä»€ä¹ˆã€‚

## å•å¡æ—¶ä»£
ä¹‹å‰ï¼Œä¸€ä¸ªæ·±åº¦å­¦ä¹ æ¨¡å‹å¹¶æ²¡æœ‰è¶…è¿‡å•ä¸ªæ˜¾å¡çš„æ˜¾å­˜ï¼Œå…¶å…¨éƒ¨æ¨¡å‹å‚æ•°éƒ½å¯ä»¥åŠ è½½åˆ°ä¸€ä¸ªGPUä¸­ï¼Œ å¹¶ä¸”åœ¨å•å¡å®Œæˆæ•´ä¸ªè®­ç»ƒæˆ–è€…æ¨ç†è¿‡ç¨‹ã€‚è¿™ä¸ªæ—¶ä»£ï¼Œå¤§å®¶éƒ½èƒ½å¾ˆæ„‰å¿«çš„ç©è€ã€‚

## å¤šå¡å¹¶è¡Œæ—¶ä»£
åæ¥éšç€æ˜¾å¡è¶Šæ¥è¶Šä¾¿å®œï¼Œè®­ç»ƒæ•°æ®é‡è¶Šæ¥è¶Šå¤šï¼Œäººä»¬é€æ¸å¼€å§‹ç ”ç©¶å¦‚ä½•åˆ©ç”¨å¤šå¡åŠ é€Ÿæ¨¡å‹çš„è®­ç»ƒï¼Œå®ç°æ€è·¯ä¹Ÿå¾ˆå¸¸è§„ï¼Œ å°±æ˜¯å¤šå¼ å¡åŒæ—¶å‚ä¸è®­ç»ƒï¼Œæ¯å¼ å¡éƒ½ç‹¬ç«‹åŠ è½½æ•´ä¸ªæ¨¡å‹ï¼Œå¹¶ä¸”ç‹¬ç«‹è¿›è¡Œå‰åå‘è¿‡ç¨‹ã€‚é€šè¿‡æŠŠè®­ç»ƒæ•°æ®çš„ä¸€ä¸ªå¤§çš„ `batch` åˆ†æˆå¤šä¸ªå° `batch`ï¼Œæ¯å¼ å¡ç‹¬ç«‹å¤„ç†ä¸€ä¸ªå° `batch`ï¼Œæœ€åå†æŠŠå„ä¸ªå¡ä¸Šçš„æ¢¯åº¦æ±‡æ€»æ•´åˆèµ·æ¥ï¼Œåœ¨ä¸€ä¸ªä¸»å¡ï¼ˆä¸»è¿›ç¨‹ï¼‰ ä¸­è®¡ç®—æ–°çš„å‚æ•°å€¼ï¼Œç„¶åå†æŠŠæ–°å‚æ•°åŒæ­¥åˆ°å„ä¸ªå¡ä¸­ï¼Œè¿™æ ·å®ç°æ•°æ®çš„å¹¶è¡Œè®­ç»ƒï¼Œæ‰€ä»¥ç§°ä¹‹ä¸ºæ•°æ®å¹¶è¡Œï¼ˆ`Data Parallel,DP` ï¼‰ ã€‚

## å¤§æ¨¡å‹æ—¶ä»£
è¿›å…¥å¤§æ¨¡å‹æ—¶ä»£åï¼Œä¸€å¼ å¡çš„æ˜¾å­˜ä¸è¶³ä»¥åŠ è½½å®Œæ•´çš„æ¨¡å‹æˆ–è€…å®Œæˆä¸€ä¸ªè®­ç»ƒè¿‡ç¨‹ã€‚é‚£å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ

1. é¦–å…ˆè¦å¼„æ¸…æ¥šçš„æ˜¯ï¼Œæ¶ˆè€—æ˜¾å­˜çš„éƒ½æœ‰å“ªäº›ï¼Ÿ

    - æ¨¡å‹çš„å‚æ•°ã€‚
    - å‰å‘è¿‡ç¨‹ä¸­ï¼Œä¸€äº›ä¸­é—´è®¡ç®—ç»“æœä»¥åŠæ¿€æ´»å€¼ï¼ˆå³æ¿€æ´»å‡½æ•°çš„æ‰§è¡Œç»“æœï¼‰ã€‚
    - åå‘è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ªå‚æ•°çš„æ¢¯åº¦å€¼ã€‚
    - ä¼˜åŒ–å™¨çš„çŠ¶æ€ã€‚æ¯”å¦‚ `adam` ç®—æ³•ï¼Œéœ€è¦ä¸ºæ¯ä¸ªå‚æ•°å†ä¿å­˜ä¸€ä¸ªä¸€é˜¶åŠ¨é‡å’ŒäºŒé˜¶åŠ¨é‡ã€‚

2. æ¥ä¸‹æ¥ï¼Œæ€è€ƒå¦‚ä½•è§£å†³å†…å­˜ä¸è¶³çš„é—®é¢˜ã€‚æ ¸å¿ƒæ€è·¯å…¶å®å¾ˆç®€å•ï¼Œä¸»è¦æœ‰ä¸¤ä¸ªæ–¹å‘ï¼š

    1. å…ˆä¸æŠŠå…¨éƒ¨æ•°æ®åŠ è½½åˆ° `GPU` æ˜¾å­˜ï¼Œæš‚æ—¶å­˜æ”¾åœ¨åˆ«çš„åœ°æ–¹ï¼Œéœ€è¦çš„æ—¶å€™å†åŒæ­¥åˆ° `GPU` æ˜¾å­˜ä¸­ï¼Œç”¨å®Œå°±æ‰”æ‰ã€‚

        - æŠŠå‚æ•°æ”¾åˆ° `CPU` å†…å­˜ä¸­æˆ–è€…é«˜é€ŸSSDä¸­ï¼ˆæ”¯æŒNVMeçš„ssdï¼Œèµ°çš„PCI-Eæ€»çº¿ï¼‰ï¼Œè¿™å°±æ˜¯ `deepspeed` ä¸­çš„ `offload` æŠ€æœ¯ã€‚

        - å¤šå¼ GPUå¡ï¼Œæ¯å¼ å¡ä¿å­˜ä¸€éƒ¨åˆ†ï¼Œéœ€è¦çš„æ—¶å€™å†ä»å…¶ä»–å¡åŒæ­¥è¿‡æ¥ï¼Œè¿™å°±æ˜¯å‚æ•°åˆ†å‰²ã€‚

    2. é™ä½å†…å­˜çš„éœ€æ±‚ã€‚åŸæ¥æ¯ä¸ªå‚æ•°éƒ½æ˜¯ `float32` ç±»å‹ï¼Œå ç”¨4ä¸ªå­—èŠ‚ã€‚

        - æ”¹æˆåŠç²¾åº¦ï¼Œç”¨2ä¸ªå­—èŠ‚çš„ `float16` æ›¿ä»£4ä¸ªå­—èŠ‚ `float32`ï¼Œæ˜¾å­˜éœ€æ±‚ä¸€ä¸‹å°±é™ä½ä¸€åŠã€‚

        - ç”¨é‡åŒ–æŠ€æœ¯ï¼Œç”¨2ä¸ªå­—èŠ‚çš„ `int16` æˆ–è€…1ä¸ªå­—èŠ‚çš„ `int8` ä»£æ›¿4å­—èŠ‚çš„ `float32` ã€‚

æ˜¾ç„¶ï¼Œæ¯ç§æ–¹æ³•éƒ½ä¸æ˜¯å®Œç¾çš„ï¼Œéƒ½æœ‰ä¸€å®šçš„å±€é™æ€§å¹¶ä¸”ä¼šå¼•å…¥æ–°çš„é—®é¢˜ï¼Œæ¯”å¦‚ï¼š

- å‚æ•°è¿›è¡Œå¤šå¡åˆ†å‰²æˆ–è€… `offload`ï¼Œæ¯”å¦‚ä¼šå¢åŠ å¤§é‡æ•°æ®åŒæ­¥é€šä¿¡æ—¶é—´ï¼Œä¸è¦å°çœ‹è¿™éƒ¨åˆ†æ—¶é—´æ¶ˆè€—ï¼Œç›¸å¯¹äº `GPU` çš„æ˜¾å­˜è®¿é—®é€Ÿåº¦è€Œè¨€ï¼Œ å¤šæœºå™¨ä¹‹é—´çš„ç½‘ç»œé€šä¿¡ã€å•æœºå¤šå¡ä¹‹é—´é€šä¿¡ã€cpuå†…å­˜åˆ°GPUå†…å­˜çš„é€šä¿¡ï¼Œè¿™äº›éƒ½æ˜¯å·¨å¤§çš„å»¶è¿Ÿã€‚

- æ¨¡å‹è¿è¡Œä¸­ï¼Œå¤§é‡çš„æµ®ç‚¹æ•°ä¹˜æ³•ï¼Œäº§ç”Ÿå¾ˆå¤šå¾ˆå°çš„æµ®ç‚¹æ•°ï¼Œé™ä½å‚æ•°ç²¾åº¦ï¼Œä¼šé€ æˆæ•°æ®æº¢å‡ºï¼Œå¯¼è‡´å‡ºé—®é¢˜ï¼Œå³ä½¿ä¸æº¢å‡ºï¼Œä¹ŸæŸå¤±äº†æ•°æ®å‡†ç¡®æ€§ã€‚ æ¨¡å‹è®­ç»ƒæ—¶ï¼Œæ¢¯åº¦è¯¯å·®å¤§ï¼Œå¯¼è‡´æŸå¤±ä¸æ”¶æ•›ã€‚æ¨¡å‹æ¨ç†æ—¶ï¼Œè¯¯å·®å˜å¤§ï¼Œæ¨ç†æ•ˆæœå˜å·®ã€‚

## å‚æ•°åˆ†å‰²ç­–ç•¥
è¯´åˆ°åˆ†å‰²å‚æ•°ï¼Œæ— è®ºæ˜¯å¤šGPUä¹‹é—´åˆ†å‰²å‚æ•°ï¼Œè¿˜æ˜¯ `offload` åˆ°CPUå†…å­˜ï¼Œéƒ½éœ€è¦å¯¹å‚æ•°è¿›è¡Œåˆ†å‰²åˆ†ç»„ã€‚ è¿™å°±æ¶‰åŠåˆ°å¤šç§åˆ’åˆ†ç­–ç•¥ã€‚

- æŒ‰ç…§æ¨¡å‹çš„å±‚ï¼ˆLayerï¼‰è¿›è¡Œåˆ†å‰²ï¼Œä¿ç•™æ¯ä¸€å±‚ï¼ˆLayerï¼‰ä¸ºæ•´ä½“ï¼Œä¸åŒå±‚å­˜å‚¨åœ¨ä¸åŒçš„ `GPU` ä¸­ï¼Œ å¤šä¸ªå±‚ï¼ˆGPUï¼‰ä¸²è¡Œåœ¨ä¸€èµ·ï¼Œéœ€è¦ä¸²è¡Œæ‰§è¡Œï¼Œè¿™å°±æ˜¯æ‰€è°“çš„ **æµæ°´çº¿å¹¶è¡Œï¼ˆ`Pipeline Parallel,PP`ï¼‰**ã€‚æ—¶é—´æ•ˆç‡å¾ˆå·®ï¼Œ å¹¶ä¸”å¦‚æœæŸä¸€å±‚çš„å‚æ•°é‡å°±å¾ˆå¤§å¹¶è¶…è¿‡äº†å•å¡çš„æ˜¾å­˜å°±å°´å°¬ã€‚å½“ç„¶å¯ä»¥é€šè¿‡å¼‚æ­¥æ‰§è¡Œä¸€å®šç¨‹åº¦è§£å†³æ—¶é—´æ•ˆç‡å·®çš„é—®é¢˜ï¼Œæœ‰å…´è¶£çš„è¯»è€…å¯ä»¥ç ”è¯»ç›¸å…³èµ„æ–™ã€‚

- æŠŠå‚æ•°å¼ é‡åˆ‡å¼€ï¼Œåˆ‡å¼€å¼ é‡åˆ†å¼€å­˜å‚¨å¾ˆå®¹æ˜“ï¼Œä½†åˆ‡å¼€ä¹‹åï¼Œå¼ é‡è®¡ç®—çš„æ—¶å€™æ€ä¹ˆåŠï¼Ÿè¿™é‡Œå¯ä»¥åˆ†ä¸¤ç§ç­–ç•¥ã€‚ 
    1. å¼ é‡çš„è®¡ç®—è¿‡ç¨‹ä¹Ÿæ˜¯å¯ä»¥åˆ‡å‰²ï¼Œè¿™æ ·æŠŠä¸€ä¸ªå¤§çš„å¼ é‡ï¼Œåˆ‡åˆ†æˆå¤šä¸ªå°å¼ é‡ï¼Œæ¯å¼  `GPU` å¡åªä¿å­˜ä¸€ä¸ªå°ç‰‡æ®µï¼Œæ¯ä¸ªå°å¼ é‡ç‰‡æ®µï¼ˆGPUå¡ï¼‰ç‹¬ç«‹è¿›è¡Œç›¸å…³è®¡ç®—ï¼Œæœ€ååœ¨éœ€è¦çš„æ—¶å€™åˆå¹¶ç»“æœå°±è¡Œäº†ã€‚è¿™ç§æ€è·¯å°±ç§°ä¸º **å¼ é‡å¹¶è¡Œï¼ˆ`Tensor Parallel,T`Pï¼‰** , `Megatron` å°±æ˜¯èµ°çš„è¿™ä¸ªè·¯çº¿ã€‚ 
    2. åŒæ ·æ˜¯æŠŠå‚æ•°å¼ é‡åˆ†å‰²ï¼Œæ¯å¼ å¡åªä¿å­˜ä¸€ä¸ªç‰‡æ®µã€‚ä½†æ˜¯éœ€è¦è®¡ç®—çš„æ—¶å€™ï¼Œæ¯å¼ å¡éƒ½ä»å…¶ä»–å¡åŒæ­¥å…¶å®ƒç‰‡æ®µè¿‡æ¥ï¼Œæ¢å¤å®Œæ•´çš„å‚æ•°å¼ é‡ï¼Œå†ç»§ç»­æ•°æ®è®¡ç®—ã€‚`Deepspeed` é€‰å–çš„è¿™ä¸ªç­–ç•¥ï¼Œè¿™ä¸ªç­–ç•¥å®ç°èµ·æ¥æ›´ç®€å•ä¸€äº›ã€‚

## é™ä½ç²¾åº¦
é™ä½å‚æ•°ç²¾åº¦ä¹Ÿæœ‰è®²ç©¶ï¼Œæœ‰äº›åœ°æ–¹å¯ä»¥é™ä½ï¼Œæœ‰äº›åœ°æ–¹å°±ä¸èƒ½é™ä½ï¼Œæ‰€ä»¥ä¸€èˆ¬æ˜¯æ··åˆç²¾åº¦ã€‚ åŠç²¾åº¦è¿˜æœ‰å¦ä¸€ä¸ªå¥½å¤„ï¼Œå°±æ˜¯ **è®¡ç®—æ•ˆç‡æ›´é«˜**ï¼Œä¸¤ä¸ªå­—èŠ‚çš„è®¡ç®—é€Ÿåº¦è‡ªç„¶æ˜¯é«˜äº4ä¸ªå­—èŠ‚çš„ã€‚ åœ¨æ¨¡å‹è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œå‚æ•°çš„æ¢¯åº¦æ˜¯éå¸¸é‡è¦çš„ï¼Œå‚æ•°æ›´æ–°ç´¯ç§¯æ¢¯åº¦å˜åŒ–æ—¶ï¼Œå¦‚æœç²¾åº¦æŸå¤±å¤ªå¤šä¼šå¯¼è‡´æ¨¡å‹ä¸æ”¶æ•›ã€‚ æ‰€ä»¥ä¼˜åŒ–å™¨çš„çŠ¶æ€ä¸€èˆ¬éœ€è¦ä¿ç•™ `float32` ç±»å‹ï¼Œå…·ä½“å‚çœ‹ä¸‹å›¾ã€‚ æœ‰å…³æ··åˆç²¾åº¦æ›´ç»†èŠ‚å†…å®¹è¯·å‚è€ƒè®ºæ–‡ [Mixed Precision Training](https://arxiv.org/abs/1710.03740)

![](https://www.zhangzhenhu.com/_images/mixed_precision.png)

å®é™…ä¸Šï¼Œ`GPU` æ˜¾å­˜ä¸è¶³çš„é—®é¢˜æ›´å¤šçš„æ˜¯é ä¸Šé¢çš„å‚æ•°åˆ†å‰²æ¥è§£å†³ï¼ŒåŠç²¾åº¦çš„åº”ç”¨æ›´å¤šçš„æ˜¯ä¸ºäº†æé«˜è®¡ç®—é€Ÿåº¦ã€‚

æµæ°´çº¿å¹¶è¡Œã€å¼ é‡å¹¶è¡Œï¼ŒæŠŠæ¨¡å‹ä¸€æ¬¡å®Œæ•´çš„è®¡ç®—è¿‡ç¨‹ï¼ˆå‰åå‘ï¼‰åˆ†æ‹†åˆ°å¤šä¸ª `GPU` ä¸Šè¿›è¡Œï¼Œ æ‰€ä»¥è¿™ä¸¤è€…éƒ½è¢«ç§°ä¸ºæ¨¡å‹å¹¶è¡Œï¼ˆModel Parallel,MPï¼‰ã€‚ è€Œå¦‚æœæ¯å¼ å¡éƒ½èƒ½è¿›è¡Œæ¨¡å‹ä¸€æ¬¡å®Œæ•´å‰åå‘è®¡ç®—ï¼Œåªæ˜¯æ¯å¼ å¡å¤„ç†ä¸åŒçš„è®­ç»ƒæ•°æ®æ‰¹æ¬¡ï¼ˆbatchï¼‰, å°±ç§°ä¸ºæ•°æ®å¹¶è¡Œï¼ˆData Parallel,DPï¼‰ã€‚ `deepspeed` å¯¹å‚æ•°è¿›è¡Œäº†åˆ†å‰²ï¼Œæ¯å¼ å¡å­˜å‚¨ä¸€ä¸ªç‰‡æ®µï¼Œä½†åœ¨è¿›è¡Œè¿ç®—æ—¶ï¼Œ æ¯å¼ å¡éƒ½ä¼šæ¢å¤å®Œæ•´çš„å‚æ•°å¼ é‡ï¼Œæ¯å¼ å¡å¤„ç†ä¸åŒçš„æ•°æ®æ‰¹æ¬¡ï¼Œ å› æ­¤ `deepspeed` å±äºæ•°æ®å¹¶è¡Œã€‚

æœ€åæ€»ç»“ä¸€ä¸‹ï¼Œ é’ˆå¯¹å¤§æ¨¡å‹çš„è®­ç»ƒæœ‰ä¸‰ç§å¹¶è¡Œç­–ç•¥ï¼Œç†è§£èµ·æ¥å¹¶ä¸å¤æ‚ï¼š

**æ•°æ®å¹¶è¡Œ**ï¼šæ¨¡å‹çš„è®¡ç®—è¿‡ç¨‹æ²¡æœ‰åˆ†å‰²ï¼Œè®­ç»ƒæ•°æ®æ˜¯åˆ†å‰²å¹¶è¡Œå¤„ç†çš„ã€‚

**æ¨¡å‹å¹¶è¡Œï¼šæ¨¡å‹çš„è®¡ç®—è¿‡ç¨‹è¢«åˆ†å‰²**ã€‚
- æµæ°´çº¿å¹¶è¡Œï¼šæ¨¡å‹æŒ‰ç…§å±‚ï¼ˆLayerï¼‰åˆ‡åˆ†ã€‚
- å¼ é‡å¹¶è¡Œï¼šæŠŠå‚æ•°å¼ é‡åˆ‡åˆ†ï¼Œå¹¶ä¸”å°†çŸ©é˜µä¹˜æ³•åˆ†è§£åå¤š GPU å¹¶è¡Œè®¡ç®—ã€‚

## DeepSpeedæ¨ªç©ºå‡ºä¸–
åŸºäºä¸Šè¯‰å®é™…éœ€æ±‚ï¼ŒDeepSpeedåº”è¿è€Œç”Ÿã€‚DeepSpeedæ˜¯ç”±Microsoftæä¾›çš„åˆ†å¸ƒå¼è®­ç»ƒå·¥å…·ï¼Œæ—¨åœ¨æ”¯æŒæ›´å¤§è§„æ¨¡çš„æ¨¡å‹å’Œæä¾›æ›´å¤šçš„ä¼˜åŒ–ç­–ç•¥å’Œå·¥å…·ã€‚ä¸å…¶ä»–æ¡†æ¶ç›¸æ¯”ï¼ŒDeepSpeedæ”¯æŒæ›´å¤§è§„æ¨¡çš„æ¨¡å‹å’Œæä¾›æ›´å¤šçš„ä¼˜åŒ–ç­–ç•¥å’Œå·¥å…·ã€‚å…¶ä¸­ï¼Œä¸»è¦ä¼˜åŠ¿åœ¨äºæ”¯æŒæ›´å¤§è§„æ¨¡çš„æ¨¡å‹ã€æä¾›äº†æ›´å¤šçš„ä¼˜åŒ–ç­–ç•¥å’Œå·¥å…·ï¼ˆä¾‹å¦‚ ZeRO å’Œ Offload ç­‰ï¼‰ã€‚

### zeroç®€ä»‹

ZeROè®ºæ–‡:[ã€ŠZeROï¼šMemory Optimizations Toward Training Trillion Parameter Modelsã€‹](https://arxiv.org/pdf/1910.02054)

ZeRO-Offloadè®ºæ–‡ï¼š[ã€ŠZeRO-Offloadï¼šDemocratizing Billion-Scale Model Training.ã€‹](https://arxiv.org/abs/2101.06840)

NVMeæŠ€æœ¯è®ºæ–‡ï¼š[ã€Š ZeRO-Infinity: Breaking the GPU Memory Wall for Extreme Scale Deep Learningã€‹](https://arxiv.org/abs/2104.07857)

`ZeRO`ï¼ˆZero Redundancy Optimizerï¼‰æ˜¯ä¸€ç§ç”¨äºä¼˜åŒ–å¤§è§„æ¨¡æ·±åº¦å­¦ä¹ æ¨¡å‹è®­ç»ƒçš„æŠ€æœ¯ã€‚å®ƒçš„ä¸»è¦ç›®æ ‡æ˜¯é™ä½è®­ç»ƒæœŸé—´çš„å†…å­˜å ç”¨ã€é€šä¿¡å¼€é”€å’Œè®¡ç®—è´Ÿè½½ï¼Œä»è€Œä½¿ç”¨æˆ·èƒ½å¤Ÿè®­ç»ƒæ›´å¤§çš„æ¨¡å‹å¹¶æ›´é«˜æ•ˆåœ°åˆ©ç”¨ç¡¬ä»¶èµ„æºã€‚

ZEROè®ºæ–‡é¦–å…ˆåˆ†æäº†æ¨¡å‹è®­ç»ƒä¸­å†…å­˜ä¸»è¦æ¶ˆè€—åœ¨ä¸¤ä¸ªæ–¹é¢ï¼š

- `model states`ï¼šæ¨¡å‹çŠ¶æ€ï¼ŒåŒ…æ‹¬åŒ…æ‹¬ä¼˜åŒ–å™¨å‚æ•°ï¼ˆä¾‹å¦‚Adamçš„åŠ¨é‡å’Œæ–¹å·®ï¼‰ã€æ¢¯åº¦ã€æ¨¡å‹å‚æ•°
- `residual states`ï¼šå‰©ä½™çŠ¶æ€ï¼ŒåŒ…æ‹¬åŒ…æ‹¬æ¿€æ´»å‡½æ•°ã€ä¸´æ—¶ç¼“å†²åŒºã€å†…å­˜ç¢ç‰‡


![1724491526919](https://github.com/user-attachments/assets/58977c50-f76e-4e90-8a8e-a3cbaeb57d72)

`ZERO`åˆ†åˆ«ä½¿ç”¨`ZeRO-DP`å’Œ`ZeRO-R`æ¥ä¼˜åŒ–`model states`å’Œ`residual states`ã€‚å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œ`ZeRO-DP`åŒ…æ‹¬ä¸‰ä¸ªé˜¶æ®µï¼š

**ZeRO ç¬¬ 1 é˜¶æ®µ**ï¼šä¼˜åŒ–å™¨çŠ¶æ€åˆ†å‰² $P_{os}$ï¼š
åœ¨æ¯ä¸ªgpuä¸­ä¿å­˜å…¨éƒ¨çš„å‚æ•°å’Œæ¢¯åº¦ï¼Œä½†æ˜¯åªä¿å­˜ $1/{N_d}$ çš„ä¼˜åŒ–å™¨çŠ¶æ€å˜é‡ã€‚é€šè¿‡å°†ä¼˜åŒ–å™¨çŠ¶æ€è¿›è¡Œåˆ†å‰²ï¼Œå®ç°4å€çš„å†…å­˜å‡å°‘ï¼ŒåŒæ—¶ä¿æŒä¸DPç›¸åŒçš„é€šä¿¡é‡ã€‚

**ZeRO ç¬¬ 2 é˜¶æ®µ**ï¼šæ¢¯åº¦åˆ†å‰² $P_{os+g}$ï¼šæ¯ä¸ªgpuä¸­åªä¿å­˜ $1/{N_d}$ çš„æ¢¯åº¦ï¼Œå®ç°8å€çš„å†…å­˜å‡å°‘ï¼Œå¹¶ä¿æŒä¸DPç›¸åŒçš„é€šä¿¡é‡ã€‚

**ZeRO ç¬¬ 3 é˜¶æ®µ**ï¼šå‚æ•°åˆ†å‰² $P_{os+g+p}$ï¼š
æ¯ä¸ªgpuä¸­åªä¿å­˜ $1/{N_d}$ çš„å‚æ•° ï¼Œå®ç°64å€çš„å†…å­˜å‡å°‘ï¼Œé€šä¿¡é‡ä¼šç•¥å¾®å¢åŠ 50%ã€‚ä½œè€…é€šè¿‡ç”¨å°‘é‡çš„è®¡ç®—çš„æˆæœ¬å’Œé€šä¿¡æˆæœ¬æ¢æ¥äº†å¤§å¹…çš„å†…å­˜èŠ‚çœã€‚

`ZeRO-Infinity`æ˜¯ZeROçš„ä¸€ä¸ªæ‰©å±•ç‰ˆæœ¬ï¼Œå®ƒå…è®¸å°†æ¨¡å‹å‚æ•°å­˜å‚¨åœ¨CPUå†…å­˜æˆ–NVMeå­˜å‚¨ä¸Šï¼Œè€Œä¸æ˜¯å…¨éƒ¨å­˜å‚¨åœ¨GPUå†…å­˜ä¸­ï¼Œæœ€ç»ˆåœ¨æœ‰é™èµ„æºä¸‹èƒ½å¤Ÿè®­ç»ƒå‰æ‰€æœªæœ‰è§„æ¨¡çš„æ¨¡å‹ï¼ˆåœ¨å•ä¸ªNVIDIA DGX-2èŠ‚ç‚¹ä¸Šå¾®è°ƒå…·æœ‰1ä¸‡äº¿å‚æ•°çš„æ¨¡å‹ï¼‰ï¼Œè€Œæ— éœ€å¯¹æ¨¡å‹ä»£ç è¿›è¡Œé‡æ„ã€‚ä¸æ­¤åŒæ—¶ï¼Œå®ƒå®ç°äº†å‡ºè‰²çš„è®­ç»ƒååé‡å’Œå¯æ‰©å±•æ€§ï¼Œä¸å—æœ‰é™çš„CPUæˆ–NVMeå¸¦å®½çš„é™åˆ¶ã€‚

### deepspeedç®€ä»‹
2020å¹´3æœˆ`Microsoft Research`é¦–æ¬¡å¼€æºäº†`DeepSpeed` ï¼Œæ˜¯ä¸€ä¸ªç”¨äºè®­ç»ƒå¤§è§„æ¨¡æ·±åº¦å­¦ä¹ æ¨¡å‹çš„ä¼˜åŒ–å·¥å…·ï¼Œå®ƒå®ç°äº† `ZeRO` è®ºæ–‡ä¸­æè¿°çš„æ‰€æœ‰å†…å®¹ï¼Œå¯ä»¥æé«˜è®­ç»ƒé€Ÿåº¦å’Œå†…å­˜æ•ˆç‡ï¼Œå¹¶é™ä½èµ„æºéœ€æ±‚ã€‚ç›®å‰å®ƒæä¾›ä»¥ä¸‹æ”¯æŒï¼š

- Optimizer state partitioning (ZeRO stage 1)ï¼šä¼˜åŒ–å™¨çŠ¶æ€åˆ†åŒº
- Gradient partitioning (ZeRO stage 2)ï¼šæ¢¯åº¦åˆ’åˆ†ã€‚DeepSpeed ZeRO-2 ä¸»è¦ä»…ç”¨äºè®­ç»ƒï¼Œå› ä¸ºå…¶åŠŸèƒ½å¯¹æ¨ç†æ²¡æœ‰ç”¨å¤„ã€‚
- Parameter partitioning (ZeRO stage 3)ï¼šå‚æ•°åˆ’åˆ†ã€‚DeepSpeed ZeRO-3 ä¹Ÿå¯ç”¨äºæ¨ç†ï¼Œå› ä¸ºå®ƒå…è®¸åœ¨å¤šä¸ª GPU ä¸ŠåŠ è½½å¤§å‹æ¨¡å‹ï¼Œè€Œè¿™åœ¨å•ä¸ª GPU ä¸Šæ˜¯ä¸å¯èƒ½çš„ã€‚
- Custom mixed precision training handlingï¼šæ··åˆç²¾åº¦è®­ç»ƒã€‚
- A range of fast CUDA-extension-based optimizersï¼šä¸€ç³»åˆ—åŸºäº CUDA æ‰©å±•çš„å¿«é€Ÿä¼˜åŒ–å™¨
- ZeRO-Offload to CPU and NVMeï¼šæ•°æ®å¸è½½åˆ° CPU å’Œ NVMeã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å­¦ä¹ å¦‚ä½•ä½¿ç”¨è¿™ä¸ªå¼ºå¤§çš„å·¥å…·ã€‚

# å¦‚ä½•ä½¿ç”¨deepspeed?

## å®‰è£…
é€šè¿‡pypiå®‰è£…åº“ï¼š
```shell
pip install deepspeed
```
æˆ–é€šè¿‡`transformers`çš„`extras`å®‰è£…ï¼š
```shell
pip install transformers[deepspeed]
```

æœ¬åœ°æ„å»ºï¼š
```shell
git clone https://github.com/microsoft/DeepSpeed/
cd DeepSpeed
rm -rf build
TORCH_CUDA_ARCH_LIST="8.6" DS_BUILD_CPU_ADAM=1 DS_BUILD_UTILS=1 pip install . \
--global-option="build_ext" --global-option="-j8" --no-cache -v \
--disable-pip-version-check 2>&1 | tee build.log
```

## å¤šGPUéƒ¨ç½²
DeepSpeedæœ‰ä¸¤ç§å¯åŠ¨æ–¹å¼ï¼š

- ä½¿ç”¨PyTorchå¯åŠ¨å™¨ï¼šä¿æŒPyTorchçš„è®­ç»ƒæµç¨‹ï¼Œåªåœ¨å…¶ä¸­ä½¿ç”¨DeepSpeedçš„ä¸€äº›é…ç½®æ–‡ä»¶å’Œè®¾ç½®æ¥æ”¹è¿›è®­ç»ƒé€Ÿåº¦å’Œå†…å­˜æ•ˆç‡ã€‚å¥½å¤„æ˜¯æ›´å®¹æ˜“é›†æˆåˆ°ç°æœ‰çš„PyTorchä»£ç ä¸­ï¼Œå› ä¸ºå®ƒä¸éœ€è¦ä½ æ”¹å˜æ•´ä¸ªè®­ç»ƒæµç¨‹ã€‚
    ```shell
    torch.distributed.run --nproc_per_node=2 your_program.py <normal cl args> --deepspeed ds_config.json
    ```
- ä½¿ç”¨DeepSpeedæä¾›çš„å¯åŠ¨å™¨ï¼šDeepSpeedæä¾›äº†è‡ªå·±çš„å¯åŠ¨å™¨ï¼Œå®ƒæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œç”¨äºé…ç½®å’Œå¯åŠ¨DeepSpeedè®­ç»ƒã€‚è¿™ç§æ–¹å¼é€‚ç”¨äºéœ€è¦æ›´é«˜åº¦è‡ªå®šä¹‰æ§åˆ¶çš„æƒ…å†µï¼Œå¯ä»¥è½»æ¾åœ¨ä¸åŒç¯å¢ƒä¸­éƒ¨ç½²ã€‚
    ```shell
    deepspeed --num_gpus=2 your_program.py <normal cl args> --deepspeed ds_config.json
    ```
ä¸Šè¿°å‘½ä»¤ä¸­ï¼Œå„ä¸ªå­—æ®µçš„å«ä¹‰å¦‚ä¸‹ï¼š
- `deepspeed`: DeepSpeedå¯åŠ¨å™¨ï¼ˆlauncherï¼‰
- `--num_gpus=2`ï¼ˆå¯é€‰ï¼‰: æŒ‡å®šè¦ä½¿ç”¨çš„GPUæ•°é‡ï¼Œå¦‚æœè¦å¯ç”¨æ‰€æœ‰çš„GPUï¼Œå¯ä»¥çœç•¥æ­¤å‚æ•°ã€‚
- `your_program.py`: ç”¨æˆ·çš„è®­ç»ƒè„šæœ¬ã€‚åœ¨è®­ç»ƒè„šæœ¬ä¸­ä½¿ç”¨DeepSpeedæä¾›çš„ä¼˜åŒ–å™¨ã€åˆ†å¸ƒå¼è®­ç»ƒæ”¯æŒå’Œå…¶ä»–åŠŸèƒ½æ¥ä¼˜åŒ–æ‚¨çš„è®­ç»ƒä»»åŠ¡ã€‚ï¼ˆDeepSpeedé€šå¸¸è¢«é›†æˆåˆ°ç”¨æˆ·çš„è‡ªå®šä¹‰è„šæœ¬ä¸­ï¼Œä»¥æä¾›æ›´é«˜æ•ˆçš„è®­ç»ƒå’Œæ›´å¥½çš„ç¡¬ä»¶èµ„æºåˆ©ç”¨ç‡ï¼Œæ‰€ä»¥DeepSpeedåº“æœ¬èº«æ²¡æœ‰è®­ç»ƒä»£ç ã€‚ï¼‰
- `<normal cl args>`: ä¸€äº›æ™®é€šçš„å‘½ä»¤è¡Œå‚æ•°ï¼Œä»¥æŒ‡å®šè®­ç»ƒä»»åŠ¡çš„ä¸åŒé…ç½®ã€‚
- `--deepspeed ds_config.json`: ä½¿ç”¨DeepSpeedçš„é…ç½®æ–‡ä»¶`ds_config.json` æ¥é…ç½®è®­ç»ƒè¿‡ç¨‹ã€‚

ä¸‹é¢æ˜¯åœ¨DeepSpeedä¸Šä½¿ç”¨æ‰€æœ‰å¯ç”¨GPUè¿è¡Œ`run_translation.py`çš„ç¤ºä¾‹ï¼š
```shell
deepspeed examples/pytorch/translation/run_translation.py \
--deepspeed tests/deepspeed/ds_config_zero3.json \
--model_name_or_path t5-small --per_device_train_batch_size 1 \
--output_dir output_dir --overwrite_output_dir --fp16 \
--do_train --max_train_samples 500 --num_train_epochs 1 \
--dataset_name wmt16 --dataset_config "ro-en" \
--source_lang en --target_lang ro
```
## å•GPUéƒ¨ç½²
å¦‚æœæ˜¯ä½¿ç”¨ä¸€ä¸ª `GPU` éƒ¨ç½² `DeepSpeed`ï¼Œåªéœ€è¦è®¾ç½® `--num_gpus=1`ï¼Œæ˜ç¡®å‘Šè¯‰ `DeepSpeed` ä»…ä½¿ç”¨ä¸€ä¸ª `GPU`ã€‚

```shell
deepspeed --num_gpus=1 examples/pytorch/translation/run_translation.py \
--deepspeed tests/deepspeed/ds_config_zero2.json \
...
```

ä¸ºä»€ä¹ˆè¦ä½¿ç”¨åªæœ‰ä¸€ä¸ªGPUçš„DeepSpeedï¼Ÿ

- å®ƒå…·æœ‰ZeRO-offloadåŠŸèƒ½ï¼Œå¯ä»¥å°†ä¸€äº›è®¡ç®—å’Œå†…å­˜å§”æ´¾ç»™ä¸»æœºçš„CPUå’ŒRAMï¼Œä»è€Œä¸ºæ¨¡å‹çš„éœ€æ±‚ç•™ä¸‹æ›´å¤šçš„GPUèµ„æº-ä¾‹å¦‚æ›´å¤§çš„æ‰¹æ¬¡å¤§å°ï¼Œæˆ–å¯ç”¨é€šå¸¸æ— æ³•å®¹çº³çš„éå¸¸å¤§çš„æ¨¡å‹ã€‚
- å®ƒæä¾›äº†æ™ºèƒ½çš„GPUå†…å­˜ç®¡ç†ç³»ç»Ÿï¼Œæœ€å°åŒ–å†…å­˜ç¢ç‰‡åŒ–ï¼Œè¿™æ ·å†æ¬¡å¯ä»¥é€‚åº”æ›´å¤§çš„æ¨¡å‹å’Œæ•°æ®æ‰¹æ¬¡ã€‚

è¦åœ¨å…·æœ‰ä¸€ä¸ªGPUçš„DeepSpeedä¸Šè·å¾—å·¨å¤§æ”¹è¿›çš„å…³é”®æ˜¯åœ¨é…ç½®æ–‡ä»¶ä¸­è‡³å°‘æœ‰ä»¥ä¸‹é…ç½®ï¼š
```json
{
  "zero_optimization": {
     "stage": 2,
     "offload_optimizer": {
         "device": "cpu",
         "pin_memory": true
     },
     "allgather_partitions": true,
     "allgather_bucket_size": 2e8,
     "reduce_scatter": true,
     "reduce_bucket_size": 2e8,
     "overlap_comm": true,
     "contiguous_gradients": true
  }
}
```
## å¤šèŠ‚ç‚¹éƒ¨ç½²
å‡è®¾ä½ æœ‰2ä¸ªæ‹¥æœ‰8ä¸ªGPUçš„èŠ‚ç‚¹ã€‚ä½ å¯ä»¥é€šè¿‡`ssh hostname1`è®¿é—®ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œé€šè¿‡`ssh hostname2`è®¿é—®ç¬¬äºŒä¸ªèŠ‚ç‚¹ï¼Œå¹¶ä¸”ä¸¤è€…å¿…é¡»èƒ½å¤Ÿé€šè¿‡æœ¬åœ°sshåœ¨æ²¡æœ‰å¯†ç çš„æƒ…å†µä¸‹ç›¸äº’è®¿é—®ã€‚å½“ç„¶ï¼Œä½ éœ€è¦å°†è¿™äº›ä¸»æœºï¼ˆèŠ‚ç‚¹ï¼‰åç§°é‡æ–°å‘½åä¸ºä½ ä½¿ç”¨çš„å®é™…ä¸»æœºåç§°ã€‚
### torch.distributed.runå¯åŠ¨å™¨
ä¾‹å¦‚ï¼Œè¦ä½¿ç”¨`torch.distributed.run`ï¼Œä½ å¯ä»¥æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
```shell
python -m torch.distributed.run --nproc_per_node=8 --nnode=2 --node_rank=0 --master_addr=hostname1 \
--master_port=9901 your_program.py <normal cl args> --deepspeed ds_config.json
```
ä½ å¿…é¡»sshåˆ°æ¯ä¸ªèŠ‚ç‚¹å¹¶åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œç›¸åŒçš„å‘½ä»¤ï¼ä¸ç”¨ç€æ€¥ï¼Œå¯åŠ¨å™¨ä¼šç­‰å¾…ç›´åˆ°ä¸¤ä¸ªèŠ‚ç‚¹åŒæ­¥ã€‚

### deepspeedå¯åŠ¨å™¨
é¦–å…ˆå¿…é¡»åˆ›å»ºä¸€ä¸ª`hostfile`æ–‡ä»¶ï¼š
```
hostname1 slots=8
hostname2 slots=8
```

ç„¶åä½ å¯ä»¥å¯åŠ¨å®ƒï¼š
```shell
deepspeed --num_gpus 8 --num_nodes 2 --hostfile hostfile --master_addr hostname1 --master_port=9901 \
your_program.py <normal cl args> --deepspeed ds_config.json
```

ä¸`torch.distributed.run`å¯åŠ¨å™¨ä¸åŒï¼Œ`deepspeed`å°†è‡ªåŠ¨åœ¨ä¸¤ä¸ªèŠ‚ç‚¹ä¸Šå¯åŠ¨æ­¤å‘½ä»¤ï¼

## ZeRO-0é…ç½®
é˜¶æ®µ0æ˜¯ç¦ç”¨æ‰€æœ‰åˆ†ç‰‡ç±»å‹ï¼Œä»…ä½¿ç”¨DeepSpeedä½œä¸ºDDPã€‚ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•å¯ç”¨å®ƒï¼š
```json
{
    "zero_optimization": {
        "stage": 0
    }
}
```
è¿™å°†å®Œå…¨ç¦ç”¨ZeROï¼Œè€Œä½ æ— éœ€æ›´æ”¹å…¶ä»–ä»»ä½•å†…å®¹ã€‚

## ZeRO-1é…ç½®
ç¬¬1é˜¶æ®µæ˜¯ç¬¬2é˜¶æ®µå‡å»æ¢¯åº¦åˆ†ç‰‡ã€‚ä½ å¯ä»¥å°è¯•ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•æ¥ç¨å¾®åŠ å¿«é€Ÿåº¦ï¼Œåªåœ¨ä¼˜åŒ–å™¨çŠ¶æ€ä¸­è¿›è¡Œåˆ†ç‰‡ï¼š
```json
{
    "zero_optimization": {
        "stage": 1
    }
}
```

## ZeRO-2ç¤ºä¾‹
è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„ZeRO-2è‡ªåŠ¨é…ç½®æ–‡ä»¶`ds_config_zero2.json`ï¼š
```json
{
    "fp16": {
        "enabled": "auto",
        "loss_scale": 0,
        "loss_scale_window": 1000,
        "initial_scale_power": 16,
        "hysteresis": 2,
        "min_loss_scale": 1
    },

    "optimizer": {
        "type": "AdamW",
        "params": {
            "lr": "auto",
            "betas": "auto",
            "eps": "auto",
            "weight_decay": "auto"
        }
    },

    "scheduler": {
        "type": "WarmupLR",
        "params": {
            "warmup_min_lr": "auto",
            "warmup_max_lr": "auto",
            "warmup_num_steps": "auto"
        }
    },

    "zero_optimization": {
        "stage": 2,
        "offload_optimizer": {
            "device": "cpu",
            "pin_memory": true
        },
        "allgather_partitions": true,
        "allgather_bucket_size": 2e8,
        "overlap_comm": true,
        "reduce_scatter": true,
        "reduce_bucket_size": 2e8,
        "contiguous_gradients": true
    },

    "gradient_accumulation_steps": "auto",
    "gradient_clipping": "auto",
    "steps_per_print": 2000,
    "train_batch_size": "auto",
    "train_micro_batch_size_per_gpu": "auto",
    "wall_clock_breakdown": false
}
```
è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ‰‹åŠ¨è®¾ç½®çš„ZeRO-2é…ç½®æ–‡ä»¶ï¼Œä¸»è¦æ˜¯ä¸ºäº†è®©ä½ çœ‹åˆ°å…¸å‹å€¼çš„å¤–è§‚ï¼Œä½†æˆ‘ä»¬å¼ºçƒˆå»ºè®®ä½¿ç”¨å…¶ä¸­å…·æœ‰å¤šä¸ª`auto`è®¾ç½®çš„å€¼ã€‚
```json
{
    "fp16": {
        "enabled": true,
        "loss_scale": 0,
        "loss_scale_window": 1000,
        "initial_scale_power": 16,
        "hysteresis": 2,
        "min_loss_scale": 1
    },

    "optimizer": {
        "type": "AdamW",
        "params": {
            "lr": 3e-5,
            "betas": [0.8, 0.999],
            "eps": 1e-8,
            "weight_decay": 3e-7
        }
    },

    "scheduler": {
        "type": "WarmupLR",
        "params": {
            "warmup_min_lr": 0,
            "warmup_max_lr": 3e-5,
            "warmup_num_steps": 500
        }
    },

    "zero_optimization": {
        "stage": 2,
        "offload_optimizer": {
            "device": "cpu",
            "pin_memory": true
        },
        "allgather_partitions": true,
        "allgather_bucket_size": 2e8,
        "overlap_comm": true,
        "reduce_scatter": true,
        "reduce_bucket_size": 2e8,
        "contiguous_gradients": true
    },

    "steps_per_print": 2000,
    "wall_clock_breakdown": false
}
```

## ZeRO-3ç¤ºä¾‹
è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„ZeRO-3è‡ªåŠ¨é…ç½®æ–‡ä»¶`ds_config_zero3.json`ï¼š
```json
{
    "fp16": {
        "enabled": "auto",
        "loss_scale": 0,
        "loss_scale_window": 1000,
        "initial_scale_power": 16,
        "hysteresis": 2,
        "min_loss_scale": 1
    },

    "optimizer": {
        "type": "AdamW",
        "params": {
            "lr": "auto",
            "betas": "auto",
            "eps": "auto",
            "weight_decay": "auto"
        }
    },

    "scheduler": {
        "type": "WarmupLR",
        "params": {
            "warmup_min_lr": "auto",
            "warmup_max_lr": "auto",
            "warmup_num_steps": "auto"
        }
    },

    "zero_optimization": {
        "stage": 3,
        "offload_optimizer": {
            "device": "cpu",
            "pin_memory": true
        },
        "offload_param": {
            "device": "cpu",
            "pin_memory": true
        },
        "overlap_comm": true,
        "contiguous_gradients": true,
        "sub_group_size": 1e9,
        "reduce_bucket_size": "auto",
        "stage3_prefetch_bucket_size": "auto",
        "stage3_param_persistence_threshold": "auto",
        "stage3_max_live_parameters": 1e9,
        "stage3_max_reuse_distance": 1e9,
        "stage3_gather_16bit_weights_on_model_save": true
    },

    "gradient_accumulation_steps": "auto",
    "gradient_clipping": "auto",
    "steps_per_print": 2000,
    "train_batch_size": "auto",
    "train_micro_batch_size_per_gpu": "auto",
    "wall_clock_breakdown": false
}
```
è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ‰‹åŠ¨è®¾ç½®çš„ZeRO-3é…ç½®æ–‡ä»¶ï¼Œä¸»è¦æ˜¯ä¸ºäº†è®©ä½ çœ‹åˆ°å…¸å‹å€¼çš„å¤–è§‚ï¼Œä½†æˆ‘ä»¬å¼ºçƒˆå»ºè®®ä½¿ç”¨å…¶ä¸­å…·æœ‰å¤šä¸ª`auto`è®¾ç½®çš„å€¼ã€‚
```json
{
    "fp16": {
        "enabled": true,
        "loss_scale": 0,
        "loss_scale_window": 1000,
        "initial_scale_power": 16,
        "hysteresis": 2,
        "min_loss_scale": 1
    },

    "optimizer": {
        "type": "AdamW",
        "params": {
            "lr": 3e-5,
            "betas": [0.8, 0.999],
            "eps": 1e-8,
            "weight_decay": 3e-7
        }
    },

    "scheduler": {
        "type": "WarmupLR",
        "params": {
            "warmup_min_lr": 0,
            "warmup_max_lr": 3e-5,
            "warmup_num_steps": 500
        }
    },

    "zero_optimization": {
        "stage": 3,
        "offload_optimizer": {
            "device": "cpu",
            "pin_memory": true
        },
        "offload_param": {
            "device": "cpu",
            "pin_memory": true
        },
        "overlap_comm": true,
        "contiguous_gradients": true,
        "sub_group_size": 1e9,
        "reduce_bucket_size": 1e6,
        "stage3_prefetch_bucket_size": 0.94e6,
        "stage3_param_persistence_threshold": 1e4,
        "stage3_max_live_parameters": 1e9,
        "stage3_max_reuse_distance": 1e9,
        "stage3_gather_16bit_weights_on_model_save": true
    },

    "steps_per_print": 2000,
    "wall_clock_breakdown": false
}
```
## ZeRO-2ä¸ZeRO-3æ€§èƒ½è¿›è¡Œæ¯”è¾ƒ
å¦‚æœåœ¨å…¶ä»–æ‰€æœ‰é…ç½®ä¿æŒä¸å˜çš„æƒ…å†µä¸‹ï¼ŒZeRO-3å¯èƒ½æ¯”ZeRO-2æ…¢ï¼Œå› ä¸ºå‰è€…éœ€è¦æ”¶é›†æ¨¡å‹æƒé‡ï¼Œå¹¶ä¸”æ¯”ZeRO-2æ‰§è¡Œçš„æ“ä½œæ›´å¤šã€‚å¦‚æœZeRO-2æ»¡è¶³ä½ çš„éœ€æ±‚ï¼Œå¹¶ä¸”ä½ ä¸éœ€è¦åœ¨å‡ ä¸ªGPUä¹‹é—´æ‰©å±•ï¼Œé‚£ä¹ˆå¯ä»¥é€‰æ‹©ä½¿ç”¨ZeRO-2ã€‚é‡è¦çš„æ˜¯è¦äº†è§£ï¼ŒZeRO-3å¯ä»¥ä»¥æ›´é«˜çš„å¯æ‰©å±•æ€§ä¸ºä»£ä»·æä¾›æ›´é«˜çš„æ€§èƒ½ã€‚

å¯ä»¥è°ƒæ•´ZeRO-3é…ç½®ï¼Œä½¿å…¶æ€§èƒ½æ›´æ¥è¿‘äºZeRO-2ï¼š

- å°†`stage3_param_persistence_threshold`è®¾ç½®ä¸ºä¸€ä¸ªéå¸¸å¤§çš„å€¼-å¤§äºæœ€å¤§çš„å‚æ•°å€¼ï¼Œä¾‹å¦‚`6 * hidden_size * hidden_size`ã€‚è¿™å°†ä½¿å‚æ•°ä¿ç•™åœ¨GPUä¸Šã€‚
- å…³é—­`offload_params`ï¼Œå› ä¸ºZeRO-2æ²¡æœ‰è¯¥é€‰é¡¹ã€‚

å³ä½¿ä½ ä¸æ›´æ”¹`stage3_param_persistence_threshold`ï¼Œåªè¦å°†`offload_params`å…³é—­ï¼Œæ€§èƒ½å¯èƒ½ä¼šæ˜¾ç€æé«˜ã€‚å½“ç„¶ï¼Œè¿™äº›æ›´æ”¹å°†å½±å“ä½ å¯ä»¥è®­ç»ƒçš„æ¨¡å‹çš„å¤§å°ã€‚å› æ­¤ï¼Œè¿™äº›æ›´æ”¹å¯è®©ä½ åœ¨å¯æ‰©å±•æ€§å’Œé€Ÿåº¦ä¹‹é—´è¿›è¡Œæƒè¡¡ï¼Œå…·ä½“å–å†³äºä½ çš„éœ€æ±‚ã€‚

## NVMeæ”¯æŒ
é€šè¿‡ä½¿ç”¨NVMeå†…å­˜å¯ä»¥æ‰©å±•GPUå’ŒCPUå†…å­˜ï¼ŒZeRO-Infinityå…è®¸è®­ç»ƒè§„æ¨¡éå¸¸å¤§çš„æ¨¡å‹ã€‚ç”±äºæ™ºèƒ½åˆ’åˆ†å’Œå¹³é“ºç®—æ³•ï¼Œæ¯ä¸ªGPUåœ¨å¸è½½è¿‡ç¨‹ä¸­éœ€è¦å‘é€å’Œæ¥æ”¶éå¸¸å°‘é‡çš„æ•°æ®ï¼Œå› æ­¤ç°ä»£NVMeè¢«è¯æ˜é€‚åˆä¸ºè®­ç»ƒè¿‡ç¨‹æä¾›æ€»å…±æ›´å¤§çš„å†…å­˜æ± ã€‚ZeRO-Infinityéœ€è¦å¯ç”¨ZeRO-3ã€‚

ä»¥ä¸‹é…ç½®ç¤ºä¾‹å¯ç”¨äº†å°†ä¼˜åŒ–å™¨çŠ¶æ€å’Œå‚æ•°åŒæ—¶å¸è½½åˆ°NVMeï¼š
```json
{
    "zero_optimization": {
        "stage": 3,
        "offload_optimizer": {
            "device": "nvme",
            "nvme_path": "/local_nvme",
            "pin_memory": true,
            "buffer_count": 4,
            "fast_init": false
        },
        "offload_param": {
            "device": "nvme",
            "nvme_path": "/local_nvme",
            "pin_memory": true,
            "buffer_count": 5,
            "buffer_size": 1e8,
            "max_in_cpu": 1e9
        },
        "aio": {
            "block_size": 262144,
            "queue_depth": 32,
            "thread_count": 1,
            "single_submit": false,
            "overlap_events": true
        },
        "overlap_comm": true,
        "contiguous_gradients": true,
        "sub_group_size": 1e9,
        "reduce_bucket_size": "auto",
        "stage3_prefetch_bucket_size": "auto",
        "stage3_param_persistence_threshold": "auto",
        "stage3_max_live_parameters": 1e9,
        "stage3_max_reuse_distance": 1e9,
        "stage3_gather_16bit_weights_on_model_save": true
    },
}
```

ä½ å¯ä»¥é€‰æ‹©åŒæ—¶å¸è½½ä¼˜åŒ–å™¨çŠ¶æ€å’Œå‚æ•°åˆ°NVMeï¼Œæˆ–è€…åªå¸è½½å®ƒä»¬ä¸­çš„ä¸€ä¸ªï¼Œæˆ–è€…éƒ½ä¸å¸è½½ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ æœ‰å¤§é‡çš„CPUå†…å­˜å¯ç”¨ï¼Œå¯ä»¥åªå¸è½½åˆ°CPUå†…å­˜ï¼Œå› ä¸ºå®ƒçš„é€Ÿåº¦æ›´å¿«ï¼ˆæç¤ºï¼š"device": "cpu"ï¼‰ã€‚

è¿™æ˜¯å¸è½½[ä¼˜åŒ–å™¨çŠ¶æ€](https://www.deepspeed.ai/docs/config-json/#optimizer-offloading)å’Œ[å‚æ•°](https://www.deepspeed.ai/docs/config-json/#parameter-offloading)çš„å®Œæ•´æ–‡æ¡£ã€‚

ç¡®ä¿`nvme_path`å®é™…ä¸Šæ˜¯ä¸€ä¸ªNVMeï¼Œå› ä¸ºå®ƒå¯ä»¥ä¸å¸¸è§„ç¡¬ç›˜æˆ–å›ºæ€ç¡¬ç›˜ä¸€èµ·ä½¿ç”¨ï¼Œä½†é€Ÿåº¦è¦æ…¢å¾—å¤šã€‚å¿«é€Ÿå¯æ‰©å±•çš„è®­ç»ƒæ˜¯é’ˆå¯¹ç°ä»£NVMeä¼ è¾“é€Ÿåº¦è®¾è®¡çš„ï¼ˆæŒ‰ç…§å½“å‰ç¼–å†™æ—¶ï¼Œæœ€å¤§è¯»å–é€Ÿåº¦çº¦ä¸º3.5GB / sï¼Œå†™å…¥é€Ÿåº¦çº¦ä¸º3GB / sï¼‰ã€‚

## å¦‚ä½•é€‰æ‹©æœ€ä½³æ€§èƒ½çš„ZeROé˜¶æ®µå’Œå¸è½½æ–¹å¼
é€šå¸¸ï¼Œä»¥ä¸‹æƒ…å†µé€‚ç”¨ï¼š

- ä»é€Ÿåº¦è§’åº¦æ¥çœ‹ï¼ˆå·¦è¾¹æ¯”å³è¾¹å¿«ï¼‰

    é˜¶æ®µ0ï¼ˆDDPï¼‰> é˜¶æ®µ1 > é˜¶æ®µ2 > é˜¶æ®µ2 + å¸è½½ > é˜¶æ®µ3 > é˜¶æ®µ3 + å¸è½½

- ä»GPUå†…å­˜ä½¿ç”¨ç‡æ¥çœ‹ï¼ˆå³è¾¹æ¯”å·¦è¾¹æ›´é«˜æ•ˆï¼‰

    é˜¶æ®µ0ï¼ˆDDPï¼‰< é˜¶æ®µ1 < é˜¶æ®µ2 < é˜¶æ®µ2 + å¸è½½ < é˜¶æ®µ3 < é˜¶æ®µ3 + å¸è½½

å› æ­¤ï¼Œå½“ä½ å¸Œæœ›è·å¾—æœ€å¿«çš„æ‰§è¡Œé€Ÿåº¦ï¼ŒåŒæ—¶é€‚åº”æœ€å°æ•°é‡çš„GPUæ—¶ï¼Œå¯ä»¥æŒ‰ç…§ä»¥ä¸‹æµç¨‹è¿›è¡Œæ“ä½œã€‚æˆ‘ä»¬ä»æœ€å¿«çš„æ–¹æ³•å¼€å§‹ï¼Œå¦‚æœå‘ç”ŸGPU OOMï¼Œç„¶åè½¬åˆ°æ›´ä½é€Ÿçš„æ–¹æ³•ï¼Œä½†ä½¿ç”¨æ›´å°‘çš„GPUå†…å­˜ã€‚ä¾æ­¤ç±»æ¨ã€‚

é¦–å…ˆå°†æ‰¹æ¬¡å¤§å°è®¾ç½®ä¸º1ï¼ˆä½ å§‹ç»ˆå¯ä»¥ä½¿ç”¨æ¸è¿›ç´¯ç§¯è¿›è¡Œä»»ä½•æ‰€éœ€çš„æœ‰æ•ˆæ‰¹æ¬¡å¤§å°ï¼‰ã€‚

1. å¯ç”¨`--gradient_checkpointing 1`ï¼ˆHF Trainerï¼‰æˆ–ç›´æ¥`model.gradient_checkpointing_enable()`- å¦‚æœå‘ç”ŸOOMï¼Œåˆ™

2. å°è¯•é¦–å…ˆä½¿ç”¨ZeROé˜¶æ®µ2ã€‚å¦‚æœå‘ç”ŸOOMï¼Œåˆ™

3. å°è¯•ä½¿ç”¨ZeROé˜¶æ®µ2 + `offload_optimizer`ã€‚å¦‚æœå‘ç”ŸOOMï¼Œåˆ™

4. åˆ‡æ¢åˆ°ZeROé˜¶æ®µ3ã€‚å¦‚æœå‘ç”ŸOOMï¼Œåˆ™

5. å°†`offload_param`è®¾ç½®ä¸º`cpu`ã€‚å¦‚æœå‘ç”ŸOOMï¼Œåˆ™

6. å°†`offload_optimize`rè®¾ç½®ä¸º`cpu`ã€‚å¦‚æœå‘ç”ŸOOMï¼Œåˆ™

7. å¦‚æœä»ç„¶æ— æ³•é€‚åº”æ‰¹æ¬¡å¤§å°ä¸º1ï¼Œè¯·æ£€æŸ¥å„ç§é»˜è®¤å€¼ï¼Œå¹¶åœ¨å¯èƒ½çš„æƒ…å†µä¸‹å°†å…¶é™ä½ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½¿ç”¨`generate`å¹¶ä¸”ä¸ä½¿ç”¨å®½çš„æœç´¢æŸï¼Œå°†å…¶å˜ä¸ºæ›´çª„ï¼Œå› ä¸ºå®ƒä¼šæ¶ˆè€—å¤§é‡å†…å­˜ã€‚

8. ä½¿ç”¨åŠç²¾åº¦è€Œä¸æ˜¯fp32 - åœ¨AmpereåŠæ›´é«˜çš„GPUä¸Šä½¿ç”¨`bf16`ï¼Œåœ¨è¾ƒæ—§çš„GPUæ¶æ„ä¸Šä½¿ç”¨`fp16`ã€‚

9. å¦‚æœä»ç„¶å‘ç”ŸOOMï¼Œå¯ä»¥æ·»åŠ æ›´å¤šç¡¬ä»¶æˆ–å¯ç”¨ZeRO-Infinity-å°†`offload_param`å’Œ`offload_optimizer`åˆ‡æ¢åˆ°`nvme`ã€‚ä½ éœ€è¦ç¡®ä¿å®ƒæ˜¯ä¸€ä¸ªéå¸¸å¿«é€Ÿçš„`nvme`ã€‚

å½“ä½ çš„æ‰¹æ¬¡å¤§å°ä¸º1æ—¶ï¼Œæ²¡æœ‰å‘ç”ŸOOMï¼Œè¯·æµ‹é‡æœ‰æ•ˆååé‡ã€‚

æ¥ä¸‹æ¥ï¼Œå°è¯•å¢åŠ æ‰¹æ¬¡å¤§å°ï¼Œå°½å¯èƒ½å¤§ï¼Œå› ä¸ºæ‰¹æ¬¡å¤§å°è¶Šå¤§ï¼ŒGPUæ‰§è¡Œçš„æ•ˆç‡è¶Šé«˜ï¼Œå› ä¸ºå®ƒä»¬åœ¨ä¹˜ä»¥çŸ©é˜µæ—¶è¡¨ç°æœ€ä½³ï¼Œè€Œè¿™äº›çŸ©é˜µéƒ½éå¸¸å¤§ã€‚

ä½ å¯ä»¥å…³é—­ä¸€äº›å¸è½½åŠŸèƒ½æˆ–è€…é™ä½ ZeRO é˜¶æ®µï¼Œå¹¶å¢åŠ /å‡å°‘æ‰¹å¤§å°ï¼Œç„¶åå†æµ‹é‡æœ‰æ•ˆååé‡ã€‚åå¤æµ‹è¯•ç›´åˆ°æ»¡æ„ã€‚


è¿™äº›æ³¨æ„äº‹é¡¹ä¸»è¦æ˜¯ä¸ºè®­ç»ƒæ¨¡å¼ç¼–å†™çš„ï¼Œä½†å¤§éƒ¨åˆ†é€‚ç”¨äºæ¨ç†æ¨¡å¼ã€‚ä¾‹å¦‚ï¼Œåœ¨æ¨ç†æœŸé—´ï¼Œæ¸å˜æ£€æŸ¥ç‚¹æ˜¯æ— æ•ˆæ“ä½œï¼Œå› ä¸ºå®ƒåªåœ¨è®­ç»ƒæœŸé—´æœ‰ç”¨ã€‚

å¦‚æœä½ ä»å¤´å¼€å§‹è®­ç»ƒæŸä¸ªä¸œè¥¿ï¼Œè¯·å°è¯•ä½¿å¼ é‡çš„å½¢çŠ¶å¯è¢« 16 æ•´é™¤ï¼ˆä¾‹å¦‚éšè—å¤§å°ï¼‰ã€‚å¯¹äºæ‰¹å¤§å°ï¼Œè¯·è‡³å°‘å°è¯•ä½¿å…¶å¯è¢« 2 æ•´é™¤ã€‚

## activation checkpointingæˆ–gradient checkpointing

activation checkpointingå’Œgradient checkpointingæ˜¯ä¸¤ä¸ªç›¸äº’ç‹¬ç«‹çš„æœ¯è¯­ï¼ŒæŒ‡çš„æ˜¯åŒä¸€æ–¹æ³•ã€‚è¿™éå¸¸ä»¤äººå›°æƒ‘ï¼Œä½†æƒ…å†µå°±æ˜¯è¿™æ ·ã€‚

gradient checkpointingå…è®¸ä½ åœ¨ GPU å†…å­˜å’Œé€Ÿåº¦ä¹‹é—´è¿›è¡Œæƒè¡¡ï¼Œå®ƒå¯ä»¥å…‹æœ GPU OOM æˆ–å¢åŠ æ‰¹å¤§å°ï¼Œä»è€Œé€šå¸¸å¯ä»¥è·å¾—æ›´å¥½çš„æ€§èƒ½ã€‚

å› æ­¤ï¼Œä½ æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥åˆ©ç”¨æ­¤éå¸¸æœ‰ç›Šçš„åŠŸèƒ½ï¼š

- å¦‚æœè¦ä½¿ç”¨ HF transformersæ¨¡å‹ï¼Œå¯ä»¥ä½¿ç”¨ `model.gradient_checkpointing_enable()` æˆ–åœ¨ HF Trainer ä¸­ä½¿ç”¨ `--gradient_checkpointing`ï¼Œå®ƒå°†è‡ªåŠ¨ä¸ºä½ å¯ç”¨æ­¤åŠŸèƒ½ã€‚åœ¨é‚£é‡Œä½¿ç”¨äº† `torch.utils.checkpoint`ã€‚
- å¦‚æœä½ è‡ªå·±ç¼–å†™äº†æ¨¡å‹ï¼Œå¹¶ä¸”æƒ³ä½¿ç”¨ DeepSpeed çš„activation checkpointngï¼Œåˆ™å¯ä»¥ä½¿ç”¨[æ­¤å¤„](https://deepspeed.readthedocs.io/en/latest/activation-checkpointing.html)è§„å®šçš„ APIã€‚ä½ è¿˜å¯ä»¥ä½¿ç”¨ HF transformers å»ºæ¨¡ä»£ç å¹¶å°†`torch.utils.checkpoint` æ›¿æ¢ä¸º DeepSpeed çš„ APIã€‚åè€…æ›´åŠ çµæ´»ï¼Œå› ä¸ºå®ƒå…è®¸ä½ å°†å‰å‘æ¿€æ´»å¸è½½åˆ° CPU å†…å­˜ï¼Œè€Œä¸æ˜¯é‡æ–°è®¡ç®—å®ƒä»¬ã€‚

## ä¼˜åŒ–å™¨å’Œè°ƒåº¦å™¨
åªè¦ä¸å¯ç”¨ `offload_optimizer`ï¼Œå°±å¯ä»¥æ··åˆä½¿ç”¨ DeepSpeed å’Œ HuggingFace çš„è°ƒåº¦å™¨å’Œä¼˜åŒ–å™¨ï¼Œé™¤äº†ä½¿ç”¨ HuggingFace è°ƒåº¦å™¨å’Œ DeepSpeed ä¼˜åŒ–å™¨çš„ç»„åˆä¹‹å¤–:

| ç»„åˆ | HF è°ƒåº¦å™¨ | DS è°ƒåº¦å™¨ | 
|---|---|---|
| HF ä¼˜åŒ–å™¨ | æ˜¯ | æ˜¯ | 
| DS ä¼˜åŒ–å™¨ | å¦ | æ˜¯ |

å¯ä»¥ä½¿ç”¨é DeepSpeed ä¼˜åŒ–å™¨ï¼Œåªè¦å®ƒå…·æœ‰ CPU å’Œ GPU å®ç°ï¼ˆä¸åŒ…æ‹¬ LAMBï¼‰ã€‚

### ä¼˜åŒ–å™¨

ä¼˜åŒ–å™¨å¿…é¡»é€šè¿‡[æ­¤å¤„](https://www.deepspeed.ai/docs/config-json/#optimizer-parameters)è¿›è¡Œé…ç½®ã€‚DeepSpeed çš„ä¸»è¦ä¼˜åŒ–å™¨æ˜¯ Adamã€AdamWã€OneBitAdam å’Œ Lambã€‚è¿™äº›ä¼˜åŒ–å™¨å·²ç»ç»è¿‡å…¨é¢æµ‹è¯•ï¼Œå› æ­¤å»ºè®®ä½¿ç”¨ã€‚å®ƒè¿˜å¯ä»¥ä» `torch` å¯¼å…¥å…¶ä»–ä¼˜åŒ–å™¨ã€‚å¦‚æœä¸åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½® `optimizer` æ¡ç›®ï¼Œåˆ™ [`Trainer`] å°†è‡ªåŠ¨å°†å…¶è®¾ç½®ä¸º `AdamW`ï¼Œå¹¶ä½¿ç”¨æä¾›çš„å€¼æˆ–é»˜è®¤å€¼è®¾ç½®ä»¥ä¸‹å‘½ä»¤è¡Œå‚æ•°: `--learning_rate`ã€`--adam_beta1`ã€`--adam_beta2`ã€`--adam_epsilon` å’Œ `--weight_decay`ã€‚

ä»¥ä¸‹æ˜¯è‡ªåŠ¨é…ç½®çš„ `AdamW` çš„ç¤ºä¾‹:
```json
{
   "optimizer": {
       "type": "AdamW",
       "params": {
         "lr": "auto",
         "betas": "auto",
         "eps": "auto",
         "weight_decay": "auto"
       }
   }
}
```
è¯·æ³¨æ„ï¼Œå‘½ä»¤è¡Œå‚æ•°å°†è®¾ç½®é…ç½®æ–‡ä»¶ä¸­çš„å€¼ã€‚è¿™æ ·å°±æœ‰äº†ä¸€ä¸ªå®šä¹‰å€¼çš„å”¯ä¸€æ¥æºï¼Œå¹¶ä¸”é¿å…äº†ä¾‹å¦‚åœ¨ä¸åŒä½ç½®è®¾ç½®å­¦ä¹ ç‡ä¸ºä¸åŒå€¼æ—¶éš¾ä»¥æ‰¾åˆ°çš„é”™è¯¯ã€‚å‘½ä»¤è¡Œçš„è§„åˆ™ä¼˜å…ˆã€‚è¢«è¦†ç›–çš„å€¼æœ‰:

- `lr` ä½¿ç”¨ `--learning_rate` çš„å€¼
- `betas` ä½¿ç”¨ `--adam_beta1` å’Œ `--adam_beta2` çš„å€¼
- `eps` ä½¿ç”¨ `--adam_epsilon` çš„å€¼
- `weight_decay` ä½¿ç”¨ `--weight_decay` çš„å€¼

å› æ­¤ï¼Œè¯·è®°ä½åœ¨å‘½ä»¤è¡Œä¸Šè°ƒæ•´å…±äº«è¶…å‚æ•°ã€‚

ä½ è¿˜å¯ä»¥æ˜¾å¼åœ°è®¾ç½®å€¼:
```json
{
   "optimizer": {
       "type": "AdamW",
       "params": {
         "lr": 0.001,
         "betas": [0.8, 0.999],
         "eps": 1e-8,
         "weight_decay": 3e-7
       }
   }
}
```
ä½†æ˜¯ï¼Œä½ éœ€è¦è‡ªå·±åŒæ­¥ [`Trainer`] å‘½ä»¤è¡Œå‚æ•°å’Œ DeepSpeed é…ç½®æ–‡ä»¶ã€‚

å¦‚æœè¦ä½¿ç”¨å…¶ä»–æœªåˆ—å‡ºçš„ä¼˜åŒ–å™¨ï¼Œå¿…é¡»å°†å…¶æ·»åŠ åˆ°é¡¶çº§é…ç½®ä¸­ã€‚
```json
{
   "zero_allow_untested_optimizer": true
}
```
ä¸ `AdamW` ç±»ä¼¼ï¼Œä½ å¯ä»¥é…ç½®å…¶ä»–å®˜æ–¹æ”¯æŒçš„ä¼˜åŒ–å™¨ã€‚åªéœ€è®°ä½è¿™äº›ä¼˜åŒ–å™¨å¯èƒ½å…·æœ‰ä¸åŒçš„é…ç½®å€¼ã€‚ä¾‹å¦‚ï¼Œå¯¹äº Adamï¼Œä½ å°†å¸Œæœ› `weight_decay` åœ¨`0.01` å·¦å³ã€‚

æ­¤å¤–ï¼Œå½“ä¸å¸è½½ä¸€èµ·ä½¿ç”¨æ—¶ï¼Œä½¿ç”¨ Deepspeed çš„ CPU Adam ä¼˜åŒ–å™¨æ—¶æ•ˆæœæœ€å¥½ã€‚å¦‚æœè¦åœ¨å¸è½½æ—¶ä½¿ç”¨å…¶ä»–ä¼˜åŒ–å™¨ï¼Œè‡ª `deepspeed==0.8.3` ä»¥æ¥ï¼Œä½ è¿˜éœ€è¦æ·»åŠ :
```json
{
   "zero_force_ds_cpu_optimizer": false
}
```
åˆ°é¡¶çº§é…ç½®ã€‚

### è°ƒåº¦å™¨
DeepSpeed æ”¯æŒ `LRRangeTest`ã€`OneCycle`ã€`WarmupLR` å’Œ `WarmupDecayLR` å­¦ä¹ ç‡è°ƒåº¦å™¨ã€‚å®Œæ•´æ–‡æ¡£åœ¨[è¿™é‡Œ](https://www.deepspeed.ai/docs/config-json/#scheduler-parameters)ã€‚

ä»¥ä¸‹æ˜¯ DeepSpeed å’Œ ğŸ¤—Transformers ä¹‹é—´è°ƒåº¦å™¨çš„é‡å éƒ¨åˆ†ï¼š

- `WarmupLR` é€šè¿‡ `--lr_scheduler_type constant_with_warmup`ã€‚
- `WarmupDecayLR` é€šè¿‡ `--lr_scheduler_type linear`ã€‚è¿™ä¹Ÿæ˜¯ `--lr_scheduler_type` çš„é»˜è®¤å€¼ï¼Œå› æ­¤ï¼Œå¦‚æœä¸é…ç½®è°ƒåº¦å™¨ï¼Œè¿™æ˜¯é»˜è®¤çš„é…ç½®ã€‚

å¦‚æœä¸åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½® scheduler æ¡ç›®ï¼Œåˆ™ [`Trainer`] å°†ä½¿ç”¨ `--lr_scheduler_type`ã€`--learning_rate` å’Œ `--warmup_steps` æˆ– `--warmup_ratio` çš„å€¼é…ç½® ğŸ¤—Transformers ç‰ˆæœ¬ã€‚

ä»¥ä¸‹æ˜¯è‡ªåŠ¨é…ç½®çš„ `WarmupLR` çš„ç¤ºä¾‹:
```json
{
   "scheduler": {
         "type": "WarmupLR",
         "params": {
             "warmup_min_lr": "auto",
             "warmup_max_lr": "auto",
             "warmup_num_steps": "auto"
         }
     }
}
```
ç”±äºä½¿ç”¨äº† "auto"ï¼Œ[`Trainer`] å‚æ•°å°†åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®æ­£ç¡®çš„å€¼ã€‚è¿™æ ·å°±æœ‰äº†ä¸€ä¸ªå®šä¹‰å€¼çš„å”¯ä¸€æ¥æºï¼Œå¹¶ä¸”é¿å…äº†ä¾‹å¦‚åœ¨ä¸åŒä½ç½®è®¾ç½®å­¦ä¹ ç‡ä¸ºä¸åŒå€¼æ—¶éš¾ä»¥æ‰¾åˆ°çš„é”™è¯¯ã€‚å‘½ä»¤è¡Œä¼˜å…ˆã€‚è®¾ç½®çš„å€¼ä¸ºï¼š

- `warmup_min_lr` çš„å€¼ä¸º `0`ã€‚
- `warmup_max_lr` çš„å€¼ä¸º `--learning_rate`ã€‚
- `warmup_num_steps` çš„å€¼ä¸ºå¦‚æœæä¾›äº† `--warmup_steps`ï¼Œåˆ™ä½¿ç”¨è¯¥å€¼ã€‚å¦åˆ™ï¼Œå°†ä½¿ç”¨ `--warmup_ratio` ä¹˜ä»¥è®­ç»ƒæ­¥éª¤çš„æ•°é‡ï¼Œå¹¶å‘ä¸Šå–æ•´ã€‚
- `total_num_steps` çš„å€¼ä¸º `--max_steps` çš„å€¼ï¼Œå¦åˆ™åœ¨è¿è¡Œæ—¶æ ¹æ®ç¯å¢ƒã€æ•°æ®é›†çš„å¤§å°å’Œå…¶ä»–å‘½ä»¤è¡Œå‚æ•°è‡ªåŠ¨æ¨å¯¼å‡ºæ¥ï¼ˆ`WarmupDecayLR` éœ€è¦ï¼‰ã€‚

å½“ç„¶ï¼Œä½ å¯ä»¥æ¥ç®¡é…ç½®å€¼ä¸­çš„ä»»ä½•ä¸€ä¸ªæˆ–å¤šä¸ªï¼Œå¹¶è‡ªè¡Œè®¾ç½®ï¼š
```json
{
   "scheduler": {
         "type": "WarmupLR",
         "params": {
             "warmup_min_lr": 0,
             "warmup_max_lr": 0.001,
             "warmup_num_steps": 1000
         }
     }
}
```
ä½†æ˜¯ï¼Œä½ éœ€è¦è‡ªå·±åŒæ­¥ [`Trainer`] å‘½ä»¤è¡Œå‚æ•°å’Œ DeepSpeed é…ç½®ã€‚

ä¾‹å¦‚ï¼Œå¯¹äº `WarmupDecayLR`ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ¡ç›®:
```json
{
   "scheduler": {
         "type": "WarmupDecayLR",
         "params": {
             "last_batch_iteration": -1,
             "total_num_steps": "auto",
             "warmup_min_lr": "auto",
             "warmup_max_lr": "auto",
             "warmup_num_steps": "auto"
         }
     }
}
```
å®ƒå°†åœ¨åŠ è½½æ—¶è®¾ç½® `total_num_steps`ã€`warmup_max_lr`ã€`warmup_num_steps` å’Œ `total_num_steps`ã€‚

## fp32 ç²¾åº¦
Deepspeed æ”¯æŒå®Œå…¨çš„ fp32 å’Œ fp16 æ··åˆç²¾åº¦ã€‚

ç”±äº `fp16` æ··åˆç²¾åº¦éœ€è¦çš„å†…å­˜æ›´å°‘ï¼Œé€Ÿåº¦æ›´å¿«ï¼Œæ‰€ä»¥ä½ å”¯ä¸€ä¸å¸Œæœ›ä½¿ç”¨çš„æƒ…å†µæ˜¯å½“ä½ ä½¿ç”¨çš„æ¨¡å‹åœ¨æ­¤è®­ç»ƒæ¨¡å¼ä¸‹è¡¨ç°ä¸ä½³æ—¶ã€‚è¿™æ ·çš„æ¨¡å‹å¯èƒ½ä¼šæº¢å‡ºæˆ–ä¸‹æº¢ï¼Œå¯¼è‡´æŸå¤±ä¸º `NaN`ã€‚å¦‚æœæ˜¯è¿™ç§æƒ…å†µï¼Œä½ å°†å¸Œæœ›ä½¿ç”¨å®Œå…¨çš„ fp32 æ¨¡å¼ï¼Œå¹¶é€šè¿‡æ˜¾å¼ç¦ç”¨é»˜è®¤çš„ fp16 æ··åˆç²¾åº¦æ¨¡å¼æ¥ç¦ç”¨å®ƒ:

```json
{
    "fp16": {
        "enabled": false,
    }
}
```

å¦‚æœä½¿ç”¨ Ampere æ¶æ„çš„ GPUï¼Œä» pytorch 1.7 ç‰ˆæœ¬å¼€å§‹ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¼šè‡ªåŠ¨åˆ‡æ¢ä¸ºä½¿ç”¨æ›´é«˜æ•ˆçš„ `tf32` æ ¼å¼è¿›è¡ŒæŸäº›æ“ä½œï¼Œä½†ç»“æœä»ç„¶æ˜¯ `fp32`ã€‚

ä½¿ç”¨ ğŸ¤—Trainerï¼Œä½ å¯ä»¥ä½¿ç”¨ `--tf32` å¯ç”¨å®ƒï¼Œæˆ–ä½¿ç”¨ `--tf32 0` æˆ– `--no_tf32` ç¦ç”¨å®ƒã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒPyTorch ä½¿ç”¨é»˜è®¤å€¼ã€‚

```json
{
    "bf16": {
        "enabled": "auto"
    }
}
```
bf16 çš„åŠ¨æ€èŒƒå›´ä¸ fp32 ç›¸åŒï¼Œå› æ­¤ä¸éœ€è¦æœ‰æŸå¤±åŒºã€‚

å½“ä½¿ç”¨ `--bf16` æˆ– `--bf16_full_eval` å‘½ä»¤è¡Œå‚æ•°æ—¶ï¼Œå¯ç”¨æ­¤æ¨¡å¼ã€‚

ä½ è¿˜å¯ä»¥æ˜¾å¼å¯ç”¨/ç¦ç”¨æ­¤æ¨¡å¼ï¼š

```json
{
    "bf16": {
        "enabled": true
    }
}
```
æç¤º:

å¦‚æœä½ åœ¨è®­ç»ƒæ—¶ä½¿ç”¨ `æ¢¯åº¦ç´¯ç§¯`ï¼Œå¹¶å¯ç”¨äº† `bf16`ï¼Œä½ éœ€è¦æ³¨æ„ï¼Œå®ƒå°†ä»¥ `bf16` ç´¯ç§¯æ¢¯åº¦ï¼Œè¿™å¯èƒ½ä¸æ˜¯ä½ æƒ³è¦çš„ï¼Œå› ä¸ºæ­¤æ ¼å¼çš„ç²¾åº¦è¾ƒä½ï¼Œå¯èƒ½ä¼šå¯¼è‡´æœ‰æŸç´¯ç§¯ã€‚

## NCCL é›†åˆ
æœ‰ä¸€ä¸ª `dtype` æ˜¯è®­ç»ƒåˆ¶åº¦ï¼Œè¿˜æœ‰ä¸€ä¸ªå•ç‹¬çš„ `dtype` ç”¨äºé€šä¿¡é›†åˆï¼Œå¦‚å„ç§reduceå’Œgathering/scatteringæ“ä½œã€‚

æ‰€æœ‰gather/scatteræ“ä½œéƒ½ä½¿ç”¨ä¸æ•°æ®ç›¸åŒçš„ `dtype`ï¼Œå› æ­¤ï¼Œå¦‚æœä½ æ­£åœ¨ä½¿ç”¨ `bf16` è®­ç»ƒåˆ¶åº¦ï¼Œåˆ™ä»¥ `bf16` è¿›è¡Œgatherã€‚gatheræ˜¯ä¸€ä¸ªéæŸå¤±æ“ä½œã€‚

å„ç§reduceæ“ä½œå¯èƒ½ä¼šéå¸¸æœ‰æŸï¼Œä¾‹å¦‚å½“æ¢¯åº¦åœ¨å¤šä¸ª `GPU` ä¸Šè¿›è¡Œå¹³å‡æ—¶ï¼Œå¦‚æœé€šä¿¡æ˜¯åœ¨ `fp16` æˆ– `bf16` ä¸Šæ‰§è¡Œçš„ï¼Œåˆ™ç»“æœå¾ˆå¯èƒ½ä¼šæœ‰æŸ-å› ä¸ºåœ¨ä½ç²¾åº¦ä¸‹æ·»åŠ å¤šä¸ªæ•°å­—æ—¶ï¼Œç»“æœä¸æ˜¯ç²¾ç¡®çš„ã€‚ç‰¹åˆ«æ˜¯åœ¨ä½¿ç”¨ `bf16` æ—¶æ›´åŠ å¦‚æ­¤ï¼Œå› ä¸ºå®ƒçš„ç²¾åº¦ä½äº `fp16`ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œ`fp16` å·²ç»è¶³å¤Ÿå¥½ï¼Œå› ä¸ºå¹³å‡æ¢¯åº¦é€šå¸¸éå¸¸å°ã€‚å› æ­¤ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œåœ¨åŠç²¾åº¦è®­ç»ƒä¸­ä½¿ç”¨ `fp16` ä½œä¸ºreduceæ“ä½œçš„é»˜è®¤å€¼ã€‚ä½†æ˜¯ï¼Œä½ å¯¹æ­¤åŠŸèƒ½æœ‰å®Œå…¨çš„æ§åˆ¶ï¼Œå¹¶ä¸”å¦‚æœé€‰æ‹©ï¼Œå¯ä»¥æ·»åŠ ä¸€äº›é¢å¤–çš„å¼€é”€ï¼Œå¹¶ç¡®ä¿åœ¨ç´¯è®¡å®Œæˆåå°†å…¶ç´¯ç§¯åˆ°åŠç²¾åº¦ `dtype` ä¸­ï¼Œç›´åˆ°ç»“æœå‡†å¤‡å¥½åæ‰é™çº§åˆ°ä½ æ­£åœ¨è®­ç»ƒçš„åŠç²¾åº¦â€œdtypeâ€ã€‚

ä¸ºäº†è¦†ç›–é»˜è®¤å€¼ï¼Œä½ åªéœ€æ·»åŠ ä¸€ä¸ªæ–°çš„é…ç½®æ¡ç›®ï¼š
```json
{
    "communication_data_type": "fp32"
}
```

## è‡ªåŠ¨æ··åˆç²¾åº¦
ä½ å¯ä»¥ä½¿ç”¨ pytorch-like AMP æ–¹æ³•æˆ– apex-like æ–¹æ³•æ¥ä½¿ç”¨è‡ªåŠ¨æ··åˆç²¾åº¦ï¼š

### fp16
è¦é…ç½®å¸¦æœ‰ `fp16ï¼ˆfloat16ï¼‰`çš„ pytorch-like AMP æ¨¡å¼ï¼Œè¯·è®¾ç½®ï¼š
```json
{
    "fp16": {
        "enabled": "auto",
        "loss_scale": 0,
        "loss_scale_window": 1000,
        "initial_scale_power": 16,
        "hysteresis": 2,
        "min_loss_scale": 1
    }
}
```
[`Trainer`] å°†æ ¹æ® args.fp16_backend çš„å€¼å’Œ args.fp16_opt_level çš„å€¼è‡ªåŠ¨å¯ç”¨æˆ–ç¦ç”¨æ­¤æ¨¡å¼ã€‚

å½“ä¼ é€’ `--fp16` `--fp16_backend amp` `--fp16_opt_level 01` å‘½ä»¤è¡Œå‚æ•°æ—¶ï¼Œå°†å¯ç”¨æ­¤æ¨¡å¼ã€‚

ä½ è¿˜å¯ä»¥æ˜¾å¼é…ç½®æ­¤æ¨¡å¼ï¼š
```json
{
    "fp16": {
        "enabled": true,
        "loss_scale": 0,
        "loss_scale_window": 1000,
        "initial_scale_power": 16,
        "hysteresis": 2,
        "min_loss_scale": 1
    }
}
```
ä½†æ˜¯ï¼Œä½ éœ€è¦è‡ªå·±åŒæ­¥ [`Trainer`] çš„å‘½ä»¤è¡Œå‚æ•°å’Œ `DeepSpeed` çš„é…ç½®æ–‡ä»¶ã€‚

### bf16
å¦‚æœå¸Œæœ›ä½¿ç”¨ `bf16ï¼ˆbfloat16ï¼‰`è€Œä¸æ˜¯ fp16ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ä»¥ä¸‹é…ç½®éƒ¨åˆ†ï¼š
```json
{
    "bf16": {
        "enabled": "auto"
    }
}
```
`bf16` ä¸ `fp32` å…·æœ‰ç›¸åŒçš„åŠ¨æ€èŒƒå›´ï¼Œå› æ­¤ä¸éœ€è¦æœ‰æŸè¡¥ã€‚

å½“ä¼ é€’ `--bf16` æˆ– `--bf16_full_eval` å‘½ä»¤è¡Œå‚æ•°æ—¶ï¼Œå¯ç”¨æ­¤æ¨¡å¼ã€‚

ä½ è¿˜å¯ä»¥æ˜¾å¼å¯ç”¨/ç¦ç”¨æ­¤æ¨¡å¼ï¼š
```json
{
    "bf16": {
        "enabled": true
    }
}
```

## æ•…éšœæ’é™¤

### åœ¨å¯åŠ¨æ—¶ï¼Œdeepspeedè¿›ç¨‹æ— å›æº¯åœ°è¢«æ€æ­»
å¦‚æœ`deepspeed`è¿›ç¨‹åœ¨å¯åŠ¨æ—¶è¢«æ— å›æº¯åœ°æ€æ­»ï¼Œè¿™é€šå¸¸æ„å‘³ç€ç¨‹åºå°è¯•åˆ†é…çš„CPUå†…å­˜è¶…è¿‡äº†ç³»ç»Ÿæˆ–è¿›ç¨‹å…è®¸åˆ†é…çš„CPUå†…å­˜ï¼Œå› æ­¤æ“ä½œç³»ç»Ÿå†…æ ¸æ€æ­»äº†è¯¥è¿›ç¨‹ã€‚è¿™æ˜¯å› ä¸ºä½ çš„é…ç½®æ–‡ä»¶å¾ˆå¯èƒ½åŒæ—¶é…ç½®äº†`offload_optimizer`å’Œ`offload_param`å°†å…¶è½¬ç§»åˆ°äº†`cpu`ã€‚å¦‚æœä½ æœ‰`NVMe`ï¼Œå¦‚æœåœ¨ZeRO-3ä¸‹è¿è¡Œï¼Œå¯ä»¥å°è¯•å°†å…¶åˆ†æµåˆ°`NVMe`ã€‚å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•æ¥[ä¼°è®¡ä¸ºç‰¹å®šæ¨¡å‹éœ€è¦å¤šå°‘å†…å­˜](https://deepspeed.readthedocs.io/en/latest/memory.html)ã€‚

### è®­ç»ƒå’Œ/æˆ–è¯„ä¼°/é¢„æµ‹æŸå¤±ä¸ºNaN

åœ¨å°†ä»¥`bf16`æ··åˆç²¾åº¦æ¨¡å¼é¢„è®­ç»ƒçš„æ¨¡å‹ç”¨äºä¸å¸¦æ··åˆç²¾åº¦çš„`fp16`ä¸‹æ—¶ï¼Œç»å¸¸ä¼šå‘ç”ŸæŸå¤±ä¸º`NaN`çš„æƒ…å†µã€‚å¤§å¤šæ•°åŸºäºTPUå¹¶ä¸”é€šå¸¸æ˜¯è°·æ­Œå‘å¸ƒçš„æ¨¡å‹éƒ½å±äºæ­¤ç±»åˆ«ï¼ˆä¾‹å¦‚ï¼Œå‡ ä¹æ‰€æœ‰åŸºäºt5çš„æ¨¡å‹ï¼‰ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè§£å†³æ–¹æ¡ˆæ˜¯è¦ä¹ˆä½¿ç”¨`fp32`ï¼Œè¦ä¹ˆä½¿ç”¨å¦‚æœä½ çš„ç¡¬ä»¶æ”¯æŒï¼ˆTPUã€Ampere GPUæˆ–æ›´æ–°ç‰ˆæœ¬ï¼‰æ—¶ä½¿ç”¨`bf16`ã€‚

å¦ä¸€ä¸ªé—®é¢˜å¯èƒ½ä¸ä½¿ç”¨fp16æœ‰å…³ã€‚å½“é…ç½®ä»¥ä¸‹éƒ¨åˆ†æ—¶ï¼š
```json
{
    "fp16": {
        "enabled": "auto",
        "loss_scale": 0,
        "loss_scale_window": 1000,
        "initial_scale_power": 16,
        "hysteresis": 2,
        "min_loss_scale": 1
    }
}
```
å¹¶ä¸”ä½ åœ¨æ—¥å¿—ä¸­çœ‹åˆ°DeepspeedæŠ¥å‘Šå¦‚ä¸‹`OVERFLOW!`çš„æƒ…å†µï¼š
```shell
0%|                                                                                                                             | 0/189 [00:00<?, ?it/s]
 [deepscale] OVERFLOW! Rank 0 Skipping step. Attempted loss scale: 262144, reducing to 262144
  1%|â–Œ                                                                                                                    | 1/189 [00:00<01:26,  2.17it/s]
 [deepscale] OVERFLOW! Rank 0 Skipping step. Attempted loss scale: 262144, reducing to 131072.0
  1%|â–ˆâ–
 [...]
 [deepscale] OVERFLOW! Rank 0 Skipping step. Attempted loss scale: 1, reducing to 1
 14%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Œ                                                                                                   | 27/189 [00:14<01:13,  2.21it/s]
 [deepscale] OVERFLOW! Rank 0 Skipping step. Attempted loss scale: 1, reducing to 1
 15%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–                                                                                                  | 28/189 [00:14<01:13,  2.18it/s]
 [deepscale] OVERFLOW! Rank 0 Skipping step. Attempted loss scale: 1, reducing to 1
 15%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Š                                                                                                  | 29/189 [00:15<01:13,  2.18it/s]
 [deepscale] OVERFLOW! Rank 0 Skipping step. Attempted loss scale: 1, reducing to 1
[...]
```
è¿™æ„å‘³ç€DeepspeedæŸå¤±ç¼©æ”¾å™¨æ— æ³•æ‰¾åˆ°ä¸€ä¸ªå¯ä»¥å…‹æœæŸå¤±æº¢å‡ºçš„ç¼©æ”¾ç³»æ•°ã€‚


åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ é€šå¸¸éœ€è¦æé«˜`initial_scale_power`çš„å€¼ã€‚å°†å…¶è®¾ç½®ä¸º`"initial_scale_power": 32`é€šå¸¸å¯ä»¥è§£å†³è¯¥é—®é¢˜ã€‚

**æ³¨æ„äº‹é¡¹**
è™½ç„¶DeepSpeedæœ‰ä¸€ä¸ªå¯pipå®‰è£…çš„PyPIè½¯ä»¶åŒ…ï¼Œä½†å¼ºçƒˆå»ºè®®ä»[æºä»£ç ](https://github.com/microsoft/deepspeed#installation)è¿›è¡Œå®‰è£…ï¼Œä»¥ä¾¿æœ€å¥½åœ°åŒ¹é…ä½ çš„ç¡¬ä»¶ï¼Œå¹¶ä¸”å¦‚æœä½ éœ€è¦å¯ç”¨æŸäº›åŠŸèƒ½ï¼ˆå¦‚1-bit Adamï¼‰ï¼Œåœ¨pypiåˆ†å‘ä¸­æ— æ³•ä½¿ç”¨ã€‚

## ä½¿ç”¨éTrainerçš„Deepspeedé›†æˆ
å½“ä¸ä½¿ç”¨[`Trainer`]æ—¶ï¼Œ[`~integrations.HfDeepSpeedConfig`]ç”¨äºå°†Deepspeedé›†æˆåˆ°ğŸ¤—Transformersæ ¸å¿ƒåŠŸèƒ½ä¸­ã€‚å”¯ä¸€çš„éœ€è¦æ˜¯å¤„ç†Deepspeed ZeRO-3å‚æ•°èšåˆå¹¶åœ¨`from_pretrained`è°ƒç”¨æœŸé—´è‡ªåŠ¨å°†æ¨¡å‹åˆ†å‰²åˆ°å¤šä¸ªGPUä¸Šã€‚å…¶ä»–æ‰€æœ‰æ“ä½œéƒ½éœ€è¦ä½ è‡ªå·±å®Œæˆã€‚

å½“ä½¿ç”¨[`Trainer`]æ—¶ï¼Œæ‰€æœ‰æ“ä½œéƒ½ä¼šè‡ªåŠ¨å¤„ç†ã€‚

å½“ä¸ä½¿ç”¨[`Trainer`]æ—¶ï¼Œä¸ºäº†æœ‰æ•ˆåœ°éƒ¨ç½²DeepSpeed ZeRO-3ï¼Œä½ å¿…é¡»åœ¨å®ä¾‹åŒ–æ¨¡å‹ä¹‹å‰å®ä¾‹åŒ–[`~integrations.HfDeepSpeedConfig`]å¯¹è±¡ï¼Œå¹¶å°†è¯¥å¯¹è±¡ä¿æŒæ´»åŠ¨çŠ¶æ€ã€‚

å¦‚æœä½ ä½¿ç”¨Deepspeed ZeRO-1æˆ–ZeRO-2ï¼Œåˆ™æ ¹æœ¬ä¸éœ€è¦ä½¿ç”¨`HfDeepSpeedConfig`ã€‚

ä¾‹å¦‚ï¼Œå¯¹äºé¢„è®­ç»ƒæ¨¡å‹ï¼š
```python
from transformers.integrations import HfDeepSpeedConfig
from transformers import AutoModel
import deepspeed

ds_config = {...}  # deepspeedé…ç½®å¯¹è±¡æˆ–æ–‡ä»¶çš„è·¯å¾„
# å¿…é¡»åœ¨å®ä¾‹åŒ–æ¨¡å‹ä¹‹å‰è¿è¡Œä»¥æ£€æµ‹zero 3
dschf = HfDeepSpeedConfig(ds_config)  # ä¿æŒæ­¤å¯¹è±¡çš„æ´»åŠ¨çŠ¶æ€
model = AutoModel.from_pretrained("gpt2")
engine = deepspeed.initialize(model=model, config_params=ds_config, ...)
```
æˆ–è€…å¯¹äºéé¢„è®­ç»ƒæ¨¡å‹ï¼š
```python
from transformers.integrations import HfDeepSpeedConfig
from transformers import AutoModel, AutoConfig
import deepspeed

ds_config = {...}  # deepspeedé…ç½®å¯¹è±¡æˆ–æ–‡ä»¶çš„è·¯å¾„
# å¿…é¡»åœ¨å®ä¾‹åŒ–æ¨¡å‹ä¹‹å‰è¿è¡Œä»¥æ£€æµ‹zero 3
dschf = HfDeepSpeedConfig(ds_config)  # ä¿æŒæ­¤å¯¹è±¡çš„æ´»åŠ¨çŠ¶æ€
config = AutoConfig.from_pretrained("gpt2")
model = AutoModel.from_config(config)
engine = deepspeed.initialize(model=model, config_params=ds_config, ...)
```
è¯·æ³¨æ„ï¼Œå¦‚æœä½ ä¸ä½¿ç”¨[`Trainer`]é›†æˆï¼Œåˆ™å®Œå…¨ç”±ä½ è‡ªå·±è´Ÿè´£ã€‚åŸºæœ¬ä¸ŠæŒ‰ç…§[Deepspeed](https://www.deepspeed.ai/)ç½‘ç«™ä¸Šçš„æ–‡æ¡£æ“ä½œã€‚æ­¤å¤–ï¼Œå¿…é¡»æ˜¾å¼é…ç½®é…ç½®æ–‡ä»¶-æ— æ³•ä½¿ç”¨"auto"å€¼ï¼Œå¿…é¡»ä½¿ç”¨å®é™…å€¼ã€‚

## è‡ªå®šä¹‰Deepspeed ZeROæ¨ç†
ä»¥ä¸‹ç¤ºä¾‹æ¼”ç¤ºäº†å¦‚ä½•åœ¨ä¸ä½¿ç”¨[`Trainer`]æ—¶è¿›è¡ŒDeepspeed ZeROæ¨ç†ï¼Œå½“æ— æ³•å°†æ¨¡å‹è£…å…¥å•ä¸ªGPUä¸­æ—¶ã€‚è¯¥è§£å†³æ–¹æ¡ˆåŒ…æ‹¬ä½¿ç”¨é¢å¤–çš„GPUå’Œ/æˆ–å°†GPUå†…å­˜å¸è½½åˆ°CPUå†…å­˜ä¸­ã€‚

éœ€è¦äº†è§£çš„é‡è¦ç»†å¾®ä¹‹å¤„æ˜¯ï¼ŒZeROçš„è®¾è®¡æ–¹å¼å…è®¸åœ¨æ¯ä¸ªGPUä¸Šå¹¶è¡Œå¤„ç†ä¸åŒçš„è¾“å…¥ã€‚

ç¤ºä¾‹å…·æœ‰å¤§é‡æ³¨é‡Šï¼Œå¹¶ä»¥è‡ªæˆ‘è®°å½•æ–¹å¼è¿›è¡Œäº†è¯´æ˜ã€‚

ç¡®ä¿ï¼š

- å¦‚æœä½ æœ‰è¶³å¤Ÿçš„GPUå†…å­˜ï¼Œè¯·ç¦ç”¨CPU offloadï¼ˆå› ä¸ºä¼šå‡æ…¢å¤„ç†é€Ÿåº¦ï¼‰
- å¦‚æœä½ æ‹¥æœ‰Ampereæˆ–æ›´é«˜ç‰ˆæœ¬çš„GPUï¼Œè¯·å¯ç”¨ `bf16`ä»¥åŠ å¿«é€Ÿåº¦ã€‚å¦‚æœä½ æ²¡æœ‰è¿™æ ·çš„ç¡¬ä»¶ï¼Œåªè¦ä¸ä½¿ç”¨ä»¥`bf16`æ··åˆç²¾åº¦é¢„è®­ç»ƒçš„ä»»ä½•æ¨¡å‹ï¼ˆä¾‹å¦‚å¤§å¤šæ•°t5æ¨¡å‹ï¼‰ï¼Œä½ å¯ä»¥å¯ç”¨`fp16`ã€‚è¿™äº›æ¨¡å‹é€šå¸¸åœ¨`fp16`ä¸­æº¢å‡ºï¼Œå¹¶æ˜¾ç¤ºåƒåœ¾è¾“å‡ºã€‚

```python
#!/usr/bin/env python

# æ­¤è„šæœ¬æ¼”ç¤ºäº†åœ¨æ— æ³•å°†æ¨¡å‹è£…å…¥å•ä¸ªGPUä¸­æ—¶å¦‚ä½•åœ¨æ¨ç†æ¨¡å¼ä¸‹ä½¿ç”¨Deepspeed ZeROã€‚
#
# 1. ä½¿ç”¨1ä¸ªå¸¦CPUå¸è½½çš„GPU
# 2. æˆ–è€…ä½¿ç”¨å¤šä¸ªGPU
#
# é¦–å…ˆä½ éœ€è¦å®‰è£…deepspeedï¼špip install deepspeed
#
# è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨3B "bigscience/T0_3B"æ¨¡å‹ï¼Œå®ƒéœ€è¦å¤§çº¦15GBçš„GPU RAM-å› æ­¤å¯ä»¥ä½¿ç”¨1ä¸ªè¾ƒå¤§çš„æˆ–2ä¸ªè¾ƒå°çš„GPUæ¥å¤„ç†å®ƒã€‚æˆ–è€…ï¼Œä¸€ä¸ªå°å‹çš„GPUå’Œå¤§é‡çš„CPUå†…å­˜ã€‚
#
# è¦ä½¿ç”¨æ›´å¤§çš„æ¨¡å‹ï¼Œæ¯”å¦‚éœ€è¦å¤§çº¦50GBçš„"bigscience/T0"ï¼Œé™¤éä½ æ‹¥æœ‰ä¸€ä¸ª80GBçš„GPUï¼Œå¦åˆ™éœ€è¦ä½¿ç”¨2-4ä¸ªGPUã€‚ç„¶åä½ å¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´è¯¥è„šæœ¬ä»¥å¤„ç†æ›´å¤šçš„GPUã€‚
#
# æä¾›çš„deepspeedé…ç½®è¿˜æ¿€æ´»äº†CPUå†…å­˜å¸è½½ï¼Œå› æ­¤ï¼Œå¦‚æœä½ æœ‰å¤§é‡å¯ç”¨çš„CPUå†…å­˜ï¼Œå¹¶ä¸”ä¸ä»‹æ„å‡æ…¢é€Ÿåº¦ï¼Œåº”è¯¥å¯ä»¥åŠ è½½é€šå¸¸ä¸é€‚åº”å•ä¸ªGPUçš„æ¨¡å‹ã€‚å¦‚æœä½ æœ‰è¶³å¤Ÿçš„GPUå†…å­˜ï¼Œå¦‚æœä½ ä¸æƒ³è¿›è¡ŒCPUå¸è½½ï¼Œé‚£ä¹ˆç¨‹åºå°†è¿è¡Œå¾—æ›´å¿«-å› æ­¤ç¦ç”¨è¯¥éƒ¨åˆ†ã€‚
#
# è¦åœ¨1ä¸ªgpuä¸Šéƒ¨ç½²ï¼š
#
# deepspeed --num_gpus 1 t0.py
# or:
# python -m torch.distributed.run --nproc_per_node=1 t0.py
#
# è¦åœ¨2ä¸ªgpuä¸Šéƒ¨ç½²ï¼š
#
# deepspeed --num_gpus 2 t0.py
# or:
# python -m torch.distributed.run --nproc_per_node=2 t0.py


from transformers import AutoTokenizer, AutoConfig, AutoModelForSeq2SeqLM
from transformers.integrations import HfDeepSpeedConfig
import deepspeed
import os
import torch

os.environ["TOKENIZERS_PARALLELISM"] = "false"  # é¿å…å…³äºtokenizerså¹¶è¡Œæ€§çš„è­¦å‘Š

# åˆ†å¸ƒå¼è®¾ç½®
local_rank = int(os.getenv("LOCAL_RANK", "0"))
world_size = int(os.getenv("WORLD_SIZE", "1"))
torch.cuda.set_device(local_rank)
deepspeed.init_distributed()

model_name = "bigscience/T0_3B"

config = AutoConfig.from_pretrained(model_name)
model_hidden_size = config.d_model

# æ‰¹å¤„ç†å¤§å°å¿…é¡»å¯è¢«world_sizeæ•´é™¤ï¼Œä½†å¯ä»¥å¤§äºworld_size
train_batch_size = 1 * world_size

# ds_config æ³¨é‡Šï¼š
#
# - å¦‚æœä½ ä½¿ç”¨çš„æ˜¯Ampereæˆ–æ›´é«˜ç‰ˆæœ¬çš„GPUï¼Œè¯·å¯ç”¨bf16-è¿™å°†ä»¥æ··åˆç²¾åº¦è¿è¡Œå¹¶ä¸”é€Ÿåº¦æ›´å¿«ã€‚
#
# - å¯¹äºæ—§ä¸€äº›çš„GPUï¼Œä½ å¯ä»¥å¯ç”¨fp16ï¼Œä½†ä»…ä½¿ç”¨æœªç»bf16é¢„è®­ç»ƒçš„æ¨¡å‹-ä¾‹å¦‚ï¼Œæ‰€æœ‰å®˜æ–¹çš„t5æ¨¡å‹éƒ½æ˜¯ç»è¿‡bf16é¢„è®­ç»ƒçš„ã€‚
#
# - å°†offload_param.deviceè®¾ç½®ä¸º"none"æˆ–å®Œå…¨åˆ é™¤`offload_param`éƒ¨åˆ†ï¼Œå¦‚æœä½ ä¸- æƒ³è¿›è¡ŒCPUå¸è½½
#
# - å¦‚æœä½¿ç”¨`offload_param`ï¼Œä½ å¯ä»¥æ‰‹åŠ¨å¾®è°ƒstage3_param_persistence_thresholdä»¥æ§åˆ¶åº”ä¿ç•™åœ¨GPUä¸Šçš„å‚æ•°æ•°é‡- å€¼è¶Šå¤§ï¼Œå¸è½½çš„å°ºå¯¸è¶Šå°
#
# æœ‰å…³Deepspeedé…ç½®çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§
# https://huggingface.co/docs/transformers/main/main_classes/deepspeed

# ä¸ºäº†ä¿æŒä¸.jsonçš„ä¸€è‡´æ€§ä½¿ç”¨ç›¸åŒçš„æ ¼å¼ï¼Œåªæ˜¯å®ƒåœ¨true/falseä¸Šä½¿ç”¨å°å†™
# fmt: off
ds_config = {
    "fp16": {
        "enabled": False
    },
    "bf16": {
        "enabled": False
    },
    "zero_optimization": {
        "stage": 3,
        "offload_param": {
            "device": "cpu",
            "pin_memory": True
        },
        "overlap_comm": True,
        "contiguous_gradients": True,
        "reduce_bucket_size": model_hidden_size * model_hidden_size,
        "stage3_prefetch_bucket_size": 0.9 * model_hidden_size * model_hidden_size,
        "stage3_param_persistence_threshold": 10 * model_hidden_size
    },
    "steps_per_print": 2000,
    "train_batch_size": train_batch_size,
    "train_micro_batch_size_per_gpu": 1,
    "wall_clock_breakdown": False
}
# fmt: on

# ä¸‹ä¸€è¡ŒæŒ‡ç¤ºtransformersåœ¨è°ƒç”¨æ¨¡å‹çš„`from_pretrained`æ–¹æ³•æ—¶ï¼Œä½¿ç”¨deepspeed.zero.Initç›´æ¥åœ¨å¤šä¸ªgpuä¸Šå¯¹æ¨¡å‹è¿›è¡Œåˆ†åŒºã€‚
#
# **å¿…é¡»åœ¨åŠ è½½æ¨¡å‹AutoModelForSeq2SeqLM.from_pretrained(model_name)ä¹‹å‰è¿è¡Œæ­¤è¡Œ**
#
# å¦åˆ™ï¼Œæ¨¡å‹å°†é¦–å…ˆä»¥å¸¸è§„æ–¹å¼åŠ è½½ï¼Œä»…åœ¨å‰å‘æ—¶åˆ†åŒºï¼Œè¿™æ ·ä¼šæ›´ä½æ•ˆï¼Œå¹¶ä¸”åœ¨CPUå†…å­˜å¾ˆå°‘çš„æƒ…å†µä¸‹å¯èƒ½ä¼šå¤±è´¥
dschf = HfDeepSpeedConfig(ds_config)  # ä¿æŒæ­¤å¯¹è±¡çš„æ´»åŠ¨çŠ¶æ€

# ç°åœ¨å¯ä»¥åŠ è½½æ¨¡å‹ã€‚
model = AutoModelForSeq2SeqLM.from_pretrained(model_name)

# åˆå§‹åŒ–Deepspeed ZeROå¹¶ä»…å­˜å‚¨å¼•æ“å¯¹è±¡
ds_engine = deepspeed.initialize(model=model, config_params=ds_config)[0]
ds_engine.module.eval()  # æ¨ç†æ¨¡å¼

# Deepspeed ZeROå¯ä»¥åœ¨æ¯ä¸ªGPUä¸Šå¤„ç†ä¸ç›¸å…³çš„è¾“å…¥ã€‚å› æ­¤ï¼Œå¯¹äº2ä¸ªgpuï¼Œä½ å¯ä»¥åŒæ—¶å¤„ç†2ä¸ªè¾“å…¥ã€‚
# å¦‚æœåªæœ‰ä¸€ä¸ªè¦å¤„ç†çš„è¾“å…¥ï¼Œåˆ™éœ€è¦åŒæ—¶å°†ç›¸åŒçš„å­—ç¬¦ä¸²ä¼ é€’ç»™ä¸¤ä¸ªgpu
# å¦‚æœåªæœ‰ä¸€ä¸ªGPUï¼Œé‚£ä¹ˆä½ åªæœ‰rank 0ã€‚
rank = torch.distributed.get_rank()
if rank == 0:
    text_in = "Is this review positive or negative? Review: this is the best cast iron skillet you will ever buy"
elif rank == 1:
    text_in = "Is this review positive or negative? Review: this is the worst restaurant ever"

tokenizer = AutoTokenizer.from_pretrained(model_name)
inputs = tokenizer.encode(text_in, return_tensors="pt").to(device=local_rank)
with torch.no_grad():
    outputs = ds_engine.module.generate(inputs, synced_gpus=True)
text_out = tokenizer.decode(outputs[0], skip_special_tokens=True)
print(f"rank{rank}:\n   in={text_in}\n  out={text_out}")
```
å°†å…¶ä¿å­˜ä¸º`t0.py`å¹¶è¿è¡Œï¼š
```shell
$ deepspeed --num_gpus 2 t0.py
rank0:
   in=Is this review positive or negative? Review: this is the best cast iron skillet you will ever buy
  out=Positive
rank1:
   in=Is this review positive or negative? Review: this is the worst restaurant ever
  out=negative
```
è¿™æ˜¯ä¸€ä¸ªéå¸¸åŸºæœ¬çš„ç¤ºä¾‹ï¼Œä½ éœ€è¦æ ¹æ®è‡ªå·±çš„éœ€æ±‚è¿›è¡Œè°ƒæ•´ã€‚

### generateç»†å¾®å·®åˆ«
ä½¿ç”¨ZeRO Stage-3å’Œå¤šä¸ªGPUæ—¶ï¼Œå¿…é¡»é€šè¿‡è°ƒç”¨`generate(..., synced_gpus=True)`æ¥åŒæ­¥GPUã€‚å¦‚æœä¸è¿™æ ·åšï¼Œå¦‚æœæŸä¸ªGPUåœ¨å…¶ä»–GPUä¹‹å‰å®Œæˆç”Ÿæˆï¼Œåˆ™æ•´ä¸ªç³»ç»Ÿå°†å‘ç”ŸæŒ‚èµ·ï¼Œå› ä¸ºå…¶ä»–GPUå°†æ— æ³•ä»åœæ­¢ç”Ÿæˆçš„GPUæ¥æ”¶æƒé‡åˆ†ç‰‡ã€‚



